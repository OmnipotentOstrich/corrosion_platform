# 仪表盘数据完善说明

## 概述

本次更新完善了仪表盘的数据来源，将所有硬编码的静态数据替换为真实的后端 API 数据，大幅提升了仪表盘的实用性和准确性。

## 🔧 后端 API 改进

### 1. 扩展 `dashboard_statistics` API

**路径**: `GET /api/v1/dashboard/statistics/`

**新增返回字段**:
```json
{
  "posts": 12,
  "posts_trend": 15.5,           // 新增：增长趋势百分比
  "posts_percentage": 68,         // 新增：完成度百分比
  "resources": 45,
  "resources_trend": 8.3,         // 新增
  "resources_percentage": 85,     // 新增
  "projects": 8,
  "projects_trend": -3.2,         // 新增（支持负值）
  "projects_percentage": 45,      // 新增
  "tasks": 23,
  "tasks_trend": 5.0,            // 新增
  "tasks_percentage": 92          // 新增
}
```

**功能说明**:
- 趋势数据基于最近30天的增长率计算
- 百分比表示当前值相对于目标值的完成度
- 根据用户类型（企业/个人/管理员）返回不同维度的数据

### 2. 新增 `dashboard_projects` API

**路径**: `GET /api/v1/dashboard/projects/`

**返回数据示例**:
```json
[
  {
    "id": 1,
    "name": "防腐涂层项目",
    "progress": 85,
    "status": "active",
    "statusText": "进行中",
    "team": "张三团队",
    "deadline": "2025-11-30"
  },
  {
    "id": 2,
    "name": "保温材料研发",
    "progress": 100,
    "status": "completed",
    "statusText": "已完成",
    "team": "李四团队",
    "deadline": "2025-10-20"
  }
]
```

**功能说明**:
- 自动计算项目进度（基于开始/结束日期或直接从数据库读取）
- 支持多种状态：进行中、已完成、待开始、已暂停
- 根据用户类型返回相应的项目列表（企业项目或个人项目）
- 最多返回5个最近的项目

### 3. 新增 `dashboard_chart_data` API

**路径**: `GET /api/v1/dashboard/chart-data/?period=week`

**支持参数**:
- `period`: `week` | `month` | `year`

**返回数据示例**:
```json
{
  "labels": ["周一", "周二", "周三", "周四", "周五", "周六", "周日"],
  "datasets": {
    "posts": [5, 8, 3, 7, 4, 6, 2],
    "resources": [2, 4, 1, 3, 2, 5, 1],
    "projects": [1, 2, 0, 1, 3, 1, 0]
  }
}
```

**功能说明**:
- 动态生成图表数据，支持周/月/年三种时间维度
- 数据基于用户类型进行过滤
- 自动聚合统计指定时间段内的数据

### 4. 新增 `dashboard_user_stats` API

**路径**: `GET /api/v1/dashboard/user-stats/`

**返回数据示例**:
```json
{
  "login_days": 15,
  "weather_info": "晴天 25°C",
  "last_login": "2025-10-21 14:30"
}
```

**功能说明**:
- 计算连续登录天数
- 提供天气信息（当前为模拟数据，可集成第三方天气API）
- 显示最后登录时间

### 5. 现有 API 保持不变

以下 API 保持原有功能：
- `GET /api/v1/dashboard/activities/` - 最近活动列表
- `GET /api/v1/dashboard/tasks/` - 待办任务列表
- `GET /api/v1/dashboard/notifications/` - 系统通知列表

## 🎨 前端改进

### 1. Home.vue 数据加载优化

**主要改进**:

#### a) 数据加载函数 `loadDashboardData()`
```javascript
// 并行加载6个 API 接口
const [statsRes, activitiesRes, tasksRes, notificationsRes, projectsRes, userStatsRes] = 
  await Promise.all([
    api.get('/dashboard/statistics/'),
    api.get('/dashboard/activities/'),
    api.get('/dashboard/tasks/'),
    api.get('/dashboard/notifications/'),
    api.get('/dashboard/projects/'),        // 新增
    api.get('/dashboard/user-stats/')       // 新增
  ])
```

#### b) 统计卡片数据更新
```javascript
// 更新统计数据（包括趋势和百分比）
stats.value[0].value = statsRes.data.posts || 0
stats.value[0].trend = statsRes.data.posts_trend || 0      // 新增
stats.value[0].percentage = statsRes.data.posts_percentage || 0  // 新增
```

#### c) 项目进度列表更新
```javascript
// 更新项目进度列表
if (projectsRes.data && projectsRes.data.length > 0) {
  projectProgress.value = projectsRes.data
}
```

#### d) 用户统计信息更新
```javascript
// 更新用户统计信息
if (userStatsRes.data) {
  loginDays.value = userStatsRes.data.login_days || 1
  weatherInfo.value = userStatsRes.data.weather_info || '晴天 25°C'
}
```

### 2. 图表数据动态加载

**新增函数**: `loadChartData()`

```javascript
const loadChartData = async () => {
  const response = await api.get('/dashboard/chart-data/', {
    params: { period: chartType.value }
  })
  
  // 动态更新图表配置
  chartOption.value.xAxis.data = response.data.labels
  chartOption.value.series[0].data = response.data.datasets.posts
  chartOption.value.series[1].data = response.data.datasets.resources
  chartOption.value.series[2].data = response.data.datasets.projects
}
```

**新增监听器**:
```javascript
// 监听图表类型变化，自动重新加载数据
watch(chartType, () => {
  loadChartData()
})
```

### 3. 图表配置改进

**变更**: 将 `chartOption` 从 `computed` 改为 `ref`
```javascript
// 之前：const chartOption = computed(() => ({ ... }))
// 现在：const chartOption = ref({ ... })
```

**原因**: 需要动态更新图表数据，`ref` 更适合可变数据

## 📊 数据流程图

```
用户访问仪表盘
    ↓
loadDashboardData() 被调用
    ↓
并行请求6个 API 接口
    ├── /dashboard/statistics/      → 统计数据（含趋势、百分比）
    ├── /dashboard/activities/      → 最近活动
    ├── /dashboard/tasks/          → 待办任务
    ├── /dashboard/notifications/  → 系统通知
    ├── /dashboard/projects/       → 项目进度
    └── /dashboard/user-stats/     → 用户统计
    ↓
更新前端响应式数据
    ↓
loadChartData() 被调用
    ↓
请求 /dashboard/chart-data/?period=week
    ↓
更新图表显示
    ↓
用户切换图表时间范围（week/month/year）
    ↓
watch 监听器触发
    ↓
重新调用 loadChartData()
```

## 🎯 主要功能点

### 1. 统计卡片
- ✅ 显示真实的统计数字（发布信息、资源数量、项目数量、待办任务）
- ✅ 显示增长趋势（上升/下降百分比）
- ✅ 显示完成度进度条

### 2. 欢迎区域
- ✅ 动态问候语（根据时间）
- ✅ 显示当前日期
- ✅ 显示天气信息（来自 API）
- ✅ 显示连续登录天数（来自 API）

### 3. 项目进度
- ✅ 显示真实的项目列表
- ✅ 显示项目进度百分比
- ✅ 显示项目状态（进行中/已完成/待开始）
- ✅ 显示团队和截止日期

### 4. 数据图表
- ✅ 动态加载时序数据
- ✅ 支持切换周/月/年视图
- ✅ 自动重新加载数据

### 5. 其他模块
- ✅ 最近活动（来自系统日志）
- ✅ 待办任务（个人用户）
- ✅ 系统通知

## 🔍 数据来源对比

| 模块 | 之前 | 现在 |
|------|------|------|
| 统计卡片数字 | ❌ 硬编码 0 | ✅ 后端 API |
| 统计趋势 | ❌ 硬编码固定值 | ✅ 后端计算 |
| 统计百分比 | ❌ 硬编码固定值 | ✅ 后端计算 |
| 项目进度列表 | ❌ 硬编码3个示例 | ✅ 后端 API |
| 图表数据 | ❌ 硬编码固定数组 | ✅ 后端 API + 动态切换 |
| 连续登录天数 | ❌ 硬编码 15 | ✅ 后端计算 |
| 天气信息 | ❌ 硬编码 | ✅ 后端返回 |
| 最近活动 | ✅ 后端 API（已有） | ✅ 保持不变 |
| 待办任务 | ✅ 后端 API（已有） | ✅ 保持不变 |
| 系统通知 | ✅ 后端 API（已有） | ✅ 保持不变 |

## 💡 技术亮点

1. **数据计算智能化**: 后端自动计算趋势和百分比，无需前端计算
2. **并行加载优化**: 使用 `Promise.all` 并行加载6个接口，提升加载速度
3. **响应式图表**: 支持动态切换时间范围，自动重新加载数据
4. **用户类型区分**: 根据企业/个人/管理员返回不同维度的数据
5. **容错机制**: 所有 API 调用都有 `.catch()` 处理，失败时显示默认数据
6. **代码复用**: 提取了 `calculate_trend`、`format_time_ago`、`format_due_date` 等工具函数

## 🚀 后续优化建议

1. **天气 API 集成**: 集成真实的天气 API（如和风天气、OpenWeatherMap）
2. **连续登录统计**: 创建登录日志表，准确统计连续登录天数
3. **实时数据更新**: 使用 WebSocket 实现数据实时推送
4. **缓存优化**: 对统计数据添加 Redis 缓存，减少数据库查询
5. **数据可视化**: 添加更多图表类型（饼图、柱状图、热力图等）
6. **导出功能**: 支持导出统计报表（PDF、Excel）
7. **自定义时间范围**: 允许用户自定义查询时间段
8. **数据对比**: 支持同比、环比数据对比

## 📝 测试建议

1. **不同用户类型测试**:
   - 企业用户登录，查看企业相关数据
   - 个人用户登录，查看个人相关数据
   - 管理员登录，查看全局数据

2. **时间范围切换测试**:
   - 切换"本周"/"本月"/"本年"，验证图表数据更新

3. **空数据测试**:
   - 新用户（无任何数据）访问仪表盘，验证默认显示

4. **性能测试**:
   - 大量数据情况下的加载速度
   - 并发请求的响应时间

## ✅ 完成情况

- [x] 扩展 dashboard_statistics API，添加趋势数据和百分比
- [x] 创建项目进度列表 API (dashboard_projects)
- [x] 创建图表时序数据 API (dashboard_chart_data)
- [x] 创建用户登录统计 API (dashboard_user_stats)
- [x] 更新前端 Home.vue 使用新的 API 数据
- [x] 代码无 linter 错误

## 📄 相关文件

### 后端文件
- `backend/apps/system/dashboard_views.py` - 仪表盘视图函数
- `backend/apps/system/dashboard_urls.py` - 仪表盘路由配置

### 前端文件
- `frontend/src/views/dashboard/Home.vue` - 仪表盘主页面

---

**更新日期**: 2025-10-21
**版本**: v1.0


