# 🚀 快速测试管理员权限 - 修正版

## 重要提示

⚠️ **user store 不会持久化到 localStorage**，只有 `token` 会保存。  
✅ **正确的验证方式是查看登录时的 Network 请求**。

---

## 测试步骤

### 1️⃣ 重启后端服务

```bash
# 在后端目录，按 Ctrl+C 停止
cd backend
python manage.py runserver
```

### 2️⃣ 清除浏览器缓存

1. 按 **F12** 打开开发者工具
2. **Application** 标签 → **Local Storage**
3. 删除 `token` 和 `refreshToken`
4. 刷新页面

### 3️⃣ 打开 Network 标签

- **F12** → **Network** 标签
- 勾选 **Preserve log**（保留日志）
- 准备监控登录请求

### 4️⃣ 测试登录

1. 访问 http://localhost:5173/login
2. 点击**绿色的"系统管理员"**按钮
3. 观察 Network 标签

---

## ✅ 验证权限是否正常

### 方法1：查看登录响应（推荐）

在 **Network** 标签中：

1. 找到 `login` 请求（或 `auth/login/`）
2. 点击它
3. 查看 **Response** 标签

**应该看到类似这样的响应**：

```json
{
  "access": "eyJ0eXAiOiJKV1Qi...",
  "refresh": "eyJ0eXAiOiJKV1Qi...",
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@corrosion-platform.com",
    "first_name": "系统",
    "last_name": "管理员",
    "user_type": "personal",
    "is_staff": true,        ✅ 必须是 true
    "is_superuser": true,    ✅ 必须是 true
    "roles": [
      {
        "id": 1,
        "name": "系统管理员",
        "code": "admin"
      }
    ]
  }
}
```

**关键检查点**：
- ✅ `user.is_staff` 应该是 `true`
- ✅ `user.is_superuser` 应该是 `true`
- ✅ 如果这两个字段存在且为 `true`，说明修复成功！

### 方法2：在登录后立即查看（推荐）

登录成功后，**立即**在控制台（Console）输入：

```javascript
// 注意：必须在登录后立即执行
import { useUserStore } from '@/stores/user'
const userStore = useUserStore()

console.log('=== 用户信息 ===')
console.log('用户名:', userStore.user?.username)
console.log('is_staff:', userStore.user?.is_staff)
console.log('is_superuser:', userStore.user?.is_superuser)
console.log('isAdmin:', userStore.isAdmin)
```

如果上面的不工作（因为模块导入问题），使用这个：

```javascript
// 这个可以直接使用
console.log('Token 存在:', !!localStorage.getItem('token'))
```

### 方法3：查看页面跳转

最简单的验证方法：

1. 点击"系统管理员"登录按钮
2. **如果能成功跳转到 `/dashboard/system` 页面**
3. **能看到系统管理的统计数据**
4. ✅ 说明权限正常！

---

## 🔍 详细检查步骤

### Step 1: 检查后端返回的数据

**打开新终端，测试后端序列化器**：

```bash
cd backend
python manage.py shell -c "from apps.users.models import User; from apps.users.serializers import UserSerializer; admin = User.objects.filter(username='admin').first(); data = UserSerializer(admin).data; print('✓ 测试后端序列化'); print('is_staff:', data.get('is_staff')); print('is_superuser:', data.get('is_superuser'))"
```

**预期输出**：
```
✓ 测试后端序列化
is_staff: True
is_superuser: True
```

如果输出是 `None` 或 `False`，说明后端序列化器还有问题。

### Step 2: 检查 API 请求

1. **打开 Postman** 或使用 **curl**：

```bash
# 1. 先登录获取 token
curl -X POST http://localhost:8000/api/v1/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

2. **查看响应**，确认包含 `is_staff` 和 `is_superuser` 字段

### Step 3: 查看前端日志

登录时，在浏览器控制台应该能看到：

```
登录成功
正在跳转...
```

如果看到错误消息，记录下来以便排查。

---

## ❌ 常见问题

### 问题1: Network 中没有看到 login 请求

**原因**：可能太快，请求已经完成了

**解决**：
1. 刷新页面
2. 先打开 Network 标签
3. 勾选 "Preserve log"
4. 再点击登录按钮

### 问题2: 响应中没有 is_staff 字段

**原因**：后端还没有重启

**解决**：
```bash
# 停止后端 (Ctrl+C)
cd backend
python manage.py runserver
```

### 问题3: 登录后仍然显示"没有权限"

**检查以下几点**：

1. **后端是否返回了 is_staff**
   - Network → login 请求 → Response
   - 查找 `"is_staff": true`

2. **前端是否能正确读取**
   - 登录后在 Console 查看是否有错误

3. **路由守卫是否正确**
   - 检查 `frontend/src/router/index.js`

---

## 🎯 完整测试流程

### 测试清单

- [ ] 1. 后端已重启
- [ ] 2. 浏览器缓存已清除（token 删除）
- [ ] 3. Network 标签已打开并勾选 "Preserve log"
- [ ] 4. 点击"系统管理员"登录按钮
- [ ] 5. 查看 Network 中的 login 响应
- [ ] 6. 确认响应包含 `"is_staff": true`
- [ ] 7. 确认页面跳转到 `/dashboard/system`
- [ ] 8. 确认能看到系统管理数据

全部 ✅ = 权限正常！

---

## 📸 截图参考

### 正确的 Network 响应应该是：

```
Status: 200 OK
Response:
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "user": {
    "id": 1,
    "username": "admin",
    "is_staff": true,         ← 看这里！
    "is_superuser": true,     ← 看这里！
    ...
  }
}
```

### 正确的页面跳转：

```
登录前: http://localhost:5173/login
        ↓ 点击"系统管理员"
登录后: http://localhost:5173/dashboard/system  ← 自动跳转
```

---

## 🆘 仍然有问题？

### 提供以下信息：

1. **后端测试输出**：
   ```bash
   python manage.py shell -c "from apps.users.models import User; from apps.users.serializers import UserSerializer; admin = User.objects.filter(username='admin').first(); print('is_staff:', UserSerializer(admin).data.get('is_staff'))"
   ```

2. **Network 响应截图**：
   - F12 → Network → login 请求 → Response 标签

3. **Console 错误信息**：
   - F12 → Console → 所有红色错误

4. **是否成功跳转**：
   - 登录后的 URL 是什么？

---

## ✅ 预期结果

**如果一切正常**：

1. ✅ 点击"系统管理员"按钮
2. ✅ 看到 "管理员登录成功！" 提示
3. ✅ 自动跳转到 `/dashboard/system`
4. ✅ 能看到系统统计数据（用户数、角色数等）
5. ✅ Network 响应包含 `is_staff: true`
6. ✅ 左侧菜单显示系统管理选项

**如果还有问题，请截图 Network 响应，我会继续帮您排查！**

---

**最后更新**: 2024-10-21  
**状态**: ✅ 修复完成，请按此文档测试


