# 注册时选择角色功能修复完成

## ✅ 问题已修复

**问题原因：** 
在`UserCreateSerializer`的`create`方法中，代码试图弹出`role`字段，但实际字段名是`role_id`，导致KeyError异常。

**修复内容：**

### 🔧 后端修复
1. **修复字段名错误** - 将`role = validated_data.pop('role', None)`改为`role_id = validated_data.pop('role_id', None)`
2. **完善角色分配逻辑** - 正确处理用户选择的角色ID
3. **添加错误处理** - 当选择的角色不存在时，记录错误但不影响用户创建
4. **保持默认角色分配** - 当用户没有选择角色时，根据用户类型自动分配默认角色

### 📝 修复详情

#### 修复前的问题代码：
```python
def create(self, validated_data):
    # ...
    role = validated_data.pop('role', None)  # ❌ 错误：应该是role_id
    # ...
    if role:  # ❌ 这里会出错
        UserRole.objects.create(user=user, role=role)
```

#### 修复后的正确代码：
```python
def create(self, validated_data):
    # ...
    role_id = validated_data.pop('role_id', None)  # ✅ 正确
    # ...
    if role_id:
        try:
            role = Role.objects.get(id=role_id)
            UserRole.objects.create(user=user, role=role)
        except Role.DoesNotExist:
            # 记录错误但不影响用户创建
            logger.error(f"选择的角色ID {role_id} 不存在")
```

## 🧪 测试结果

### 获取可用角色测试
- ✅ 状态码: 200
- ✅ 成功获取7个可用角色
- ✅ 角色列表包含：个人用户、劳务人员、工程师等

### 注册功能测试
- ✅ 状态码: 201
- ✅ 用户注册成功
- ✅ 正确分配选择的角色（个人用户）
- ✅ 用户信息完整返回

## 🎯 功能特性

现在注册时选择角色功能完全正常：
- ✅ 用户可以选择合适的角色
- ✅ 角色选择是必填项
- ✅ 根据用户类型过滤可用角色
- ✅ 正确分配选择的角色
- ✅ 错误处理和用户反馈

## 🔍 角色分配逻辑

### 用户选择角色时
1. 验证角色ID是否存在
2. 如果存在，分配选择的角色
3. 如果不存在，记录错误但不影响注册

### 用户未选择角色时
1. 根据用户类型自动分配默认角色
2. 企业用户 → 企业管理员角色
3. 个人用户 → 个人用户角色

## 🚀 使用方法

1. 访问注册页面
2. 选择用户类型（企业用户/个人用户）
3. 从下拉菜单中选择合适的角色
4. 填写其他必要信息
5. 提交注册表单
6. 系统会自动分配选择的角色

## 📋 可用角色列表

### 个人用户可选角色
- 个人用户
- 劳务人员
- 工程师
- 技术人员
- 施工人员
- 行业顾问
- 行业专家

### 企业用户可选角色
- 企业管理员
- 企业员工
- 项目经理
- 质量监督员
- 安全管理员
- 材料管理员

现在注册时选择角色功能已经完全修复并可以正常使用了！
