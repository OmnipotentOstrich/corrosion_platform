# 测试登录功能验证步骤

## 前置条件

1. ✅ 数据库已配置并可访问
2. ✅ Python 环境已安装（Python 3.8+）
3. ✅ Node.js 环境已安装（Node 16+）
4. ✅ 所有依赖已安装

## 验证步骤

### 第一步：初始化后端

```bash
cd backend

# 一键初始化（推荐）
python quick_setup.py

# 或手动执行以下步骤：
# python manage.py migrate
# python init_database.py
# python create_test_users.py
```

**预期结果：**
```
============================================================
防腐保温智能数字平台 - 快速初始化
============================================================

【步骤 1/3】数据库迁移
✓ 数据库迁移成功

【步骤 2/3】初始化角色和菜单
✓ 创建角色: 系统管理员
✓ 创建角色: 企业管理员
...

【步骤 3/3】创建测试用户
✓ 创建用户: admin (密码: admin123)
✓ 创建用户: enterprise (密码: enterprise123)
✓ 创建用户: user (密码: user123)

✓ 初始化完成！
```

### 第二步：启动后端服务

```bash
cd backend
python manage.py runserver
```

**预期结果：**
```
Starting development server at http://127.0.0.1:8000/
Quit the server with CTRL-BREAK.
```

**验证后端运行：**
- 浏览器访问：http://localhost:8000/swagger/
- 应该能看到 API 文档页面

### 第三步：启动前端服务

打开新的终端窗口：

```bash
cd frontend
npm run dev
```

**预期结果：**
```
  VITE v5.x.x  ready in xxx ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
```

### 第四步：测试登录功能

#### 测试1：系统管理员登录

1. 访问：http://localhost:5173/login
2. 点击 **"系统管理员"** 按钮
3. 观察浏览器控制台（按F12）

**预期结果：**
- ✅ 显示 "管理员登录成功！" 消息
- ✅ 自动跳转到 `/dashboard/system` 页面
- ✅ 能看到系统管理相关菜单（用户管理、角色管理、系统日志）
- ✅ 左侧菜单显示所有模块

**检查点：**
- [ ] 控制台无错误信息
- [ ] 能看到用户头像/用户名
- [ ] 菜单正确加载
- [ ] 页面内容正常显示

#### 测试2：企业用户登录

1. 点击右上角退出登录
2. 返回登录页面
3. 点击 **"企业用户"** 按钮

**预期结果：**
- ✅ 显示 "企业用户登录成功！" 消息
- ✅ 自动跳转到 `/dashboard/enterprise` 页面
- ✅ 能看到企业相关菜单（企业信息、项目管理、员工管理）
- ✅ 左侧菜单显示企业相关模块

**检查点：**
- [ ] 控制台无错误信息
- [ ] 能看到企业用户信息
- [ ] 菜单仅显示企业用户权限内的模块
- [ ] 没有系统管理菜单

#### 测试3：个人用户登录

1. 点击右上角退出登录
2. 返回登录页面
3. 点击 **"个人用户"** 按钮

**预期结果：**
- ✅ 显示 "个人用户登录成功！" 消息
- ✅ 自动跳转到 `/dashboard/personal` 页面
- ✅ 能看到个人相关菜单（个人信息、我的项目、我的任务）
- ✅ 左侧菜单显示个人用户相关模块

**检查点：**
- [ ] 控制台无错误信息
- [ ] 能看到个人用户信息
- [ ] 菜单仅显示个人用户权限内的模块
- [ ] 没有企业管理和系统管理菜单

#### 测试4：手动输入登录

1. 在登录表单中输入用户名和密码：
   - 用户名：`admin`
   - 密码：`admin123`
2. 点击 **"登录"** 按钮

**预期结果：**
- ✅ 登录成功
- ✅ 跳转到对应页面

### 第五步：验证API调用

#### 检查网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 "Network"（网络）标签
3. 点击任一测试登录按钮
4. 查看网络请求

**预期看到以下请求：**

1. **POST** `/api/v1/auth/login/`
   - 状态码：200
   - 响应包含：`access`、`refresh`、`user` 字段
   
2. **GET** `/api/v1/auth/user-menus/`
   - 状态码：200
   - 响应包含：用户菜单数组

**请求头验证：**
- 第二个请求应包含 `Authorization: Bearer <token>` 头

#### 检查LocalStorage

1. 开发者工具 -> Application（应用）-> Storage -> Local Storage
2. 选择 `http://localhost:5173`

**预期存储：**
- `token`: JWT access token
- `refreshToken`: JWT refresh token

### 第六步：验证持久化登录

1. 登录成功后，刷新页面（F5）
2. 观察页面状态

**预期结果：**
- ✅ 页面不会跳转到登录页
- ✅ 用户信息保持显示
- ✅ 菜单正常加载

### 第七步：验证退出登录

1. 点击右上角用户头像
2. 选择"退出登录"

**预期结果：**
- ✅ 显示 "已退出登录" 消息
- ✅ 自动跳转到登录页面
- ✅ LocalStorage 中的 token 已清除

## 常见问题排查

### 问题1：点击测试登录按钮无反应

**可能原因：**
- 后端服务未启动
- 前后端端口配置错误
- CORS配置问题

**解决方法：**
```bash
# 检查后端服务
netstat -ano | findstr :8000

# 检查前端配置
# 查看 frontend/vite.config.js 中的 proxy 配置

# 检查后端 CORS 配置
# 查看 backend/config/settings.py 中的 CORS_ALLOWED_ORIGINS
```

### 问题2：显示"用户名或密码错误"

**可能原因：**
- 测试用户未创建
- 数据库未正确初始化

**解决方法：**
```bash
cd backend
# 重新创建测试用户
python create_test_users.py
```

### 问题3：登录后菜单为空

**可能原因：**
- 角色菜单未正确关联
- 用户角色未分配

**解决方法：**
```bash
cd backend
# 重新初始化角色菜单
python init_database.py
# 重新分配用户角色
python create_test_users.py
```

### 问题4：控制台报401错误

**可能原因：**
- Token 验证失败
- JWT 配置错误

**解决方法：**
```bash
# 检查 JWT 配置
# backend/config/settings.py 中的 SIMPLE_JWT 配置

# 清除浏览器缓存和 LocalStorage
# 在开发者工具中手动清除
```

### 问题5：跨域错误（CORS）

**控制台错误：**
```
Access to XMLHttpRequest at 'http://localhost:8000/api/v1/auth/login/' 
from origin 'http://localhost:5173' has been blocked by CORS policy
```

**解决方法：**
确保 `backend/config/settings.py` 包含：
```python
CORS_ALLOWED_ORIGINS = [
    "http://localhost:5173",
    "http://127.0.0.1:5173",
]
CORS_ALLOW_CREDENTIALS = True
```

## 验证清单

### 后端验证
- [ ] 数据库迁移成功
- [ ] 角色已创建（4个）
- [ ] 菜单已创建（约20个）
- [ ] 测试用户已创建（3个）
- [ ] 角色菜单关联已建立
- [ ] 后端服务正常运行

### 前端验证
- [ ] 前端服务正常运行
- [ ] 登录页面正常显示
- [ ] 三个测试登录按钮可见

### 功能验证
- [ ] 管理员登录成功
- [ ] 企业用户登录成功
- [ ] 个人用户登录成功
- [ ] 手动输入登录成功
- [ ] 登录后菜单正确显示
- [ ] 页面内容正常加载
- [ ] 退出登录功能正常
- [ ] 刷新页面保持登录状态

### API验证
- [ ] POST /api/v1/auth/login/ 返回200
- [ ] GET /api/v1/auth/user-menus/ 返回200
- [ ] Token 正确保存到 LocalStorage
- [ ] 请求头正确携带 Authorization

## 测试报告模板

```
测试日期：2024-XX-XX
测试人员：XXX
测试环境：
- 操作系统：Windows/Linux/Mac
- Python版本：3.x.x
- Node.js版本：16.x.x
- 浏览器：Chrome/Firefox/Edge xxx

测试结果：
✅ 管理员登录：通过
✅ 企业用户登录：通过
✅ 个人用户登录：通过
✅ 手动登录：通过
✅ 菜单加载：通过
✅ 退出登录：通过

问题记录：
1. [如有问题，在此记录]

总结：
所有测试用例通过，功能正常。
```

## 完成标志

当以下所有条件满足时，可以认为测试登录功能已完全修复：

1. ✅ 三个测试登录按钮都能成功登录
2. ✅ 登录后能看到正确的用户信息
3. ✅ 登录后能看到对应角色的菜单
4. ✅ 登录后能访问对应的页面内容
5. ✅ 控制台无任何错误信息
6. ✅ Network 标签显示所有API请求成功（200状态码）
7. ✅ LocalStorage 正确保存 token
8. ✅ 刷新页面保持登录状态
9. ✅ 退出登录功能正常

---

**祝测试顺利！** 🎉


