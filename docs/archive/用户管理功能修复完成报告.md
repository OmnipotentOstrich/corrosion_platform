# ç”¨æˆ·ç®¡ç†åŠŸèƒ½ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä¿®å¤å†…å®¹æ¦‚è¿°

æœ¬æ¬¡ä¿®å¤ä¸»è¦è§£å†³äº†ç”¨æˆ·ç®¡ç†é¡µé¢çš„ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
1. **åˆ†é¡µåŠŸèƒ½ç¼ºå¤±** - æ·»åŠ äº†å®Œæ•´çš„åˆ†é¡µæ”¯æŒ
2. **ç¦ç”¨å¯ç”¨åŠŸèƒ½æ— æ•ˆ** - ä¿®å¤äº†ç”¨æˆ·çŠ¶æ€æ›´æ–°åŠŸèƒ½

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. åç«¯APIæ”¹è¿›

#### 1.1 åˆ†é¡µæ”¯æŒ
- âœ… å¯ç”¨äº†Django REST Frameworkçš„é»˜è®¤åˆ†é¡µåŠŸèƒ½
- âœ… é…ç½®äº†æ¯é¡µ20æ¡è®°å½•çš„é»˜è®¤åˆ†é¡µå¤§å°
- âœ… æ”¯æŒ`page`å’Œ`page_size`å‚æ•°è¿›è¡Œåˆ†é¡µæ§åˆ¶

#### 1.2 ç”¨æˆ·çŠ¶æ€æ›´æ–°API
- âœ… æ–°å¢ä¸“é—¨çš„ç”¨æˆ·çŠ¶æ€æ›´æ–°ç«¯ç‚¹ï¼š`PATCH /api/v1/auth/users/{user_id}/status/`
- âœ… æ”¯æŒé€šè¿‡`is_active`å­—æ®µæ›´æ–°ç”¨æˆ·çŠ¶æ€
- âœ… æ·»åŠ äº†å®Œæ•´çš„é”™è¯¯å¤„ç†å’ŒéªŒè¯

#### 1.3 ç”¨æˆ·åºåˆ—åŒ–å™¨å¢å¼º
- âœ… æ·»åŠ äº†`status`ã€`status_text`ã€`role_text`ç­‰æ˜¾ç¤ºå­—æ®µ
- âœ… ä¼˜åŒ–äº†è§’è‰²æ–‡æœ¬æ˜ å°„ï¼Œæ”¯æŒæ‰€æœ‰ç³»ç»Ÿè§’è‰²
- âœ… æ·»åŠ äº†`register_time`å’Œ`last_login`æ ¼å¼åŒ–æ˜¾ç¤º

### 2. å‰ç«¯ç•Œé¢æ”¹è¿›

#### 2.1 åˆ†é¡µç»„ä»¶
- âœ… å®ç°äº†å®Œæ•´çš„åˆ†é¡µå¯¼èˆªç»„ä»¶
- âœ… æ”¯æŒä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®
- âœ… æ˜¾ç¤ºå½“å‰é¡µå’Œæ€»é¡µæ•°ä¿¡æ¯
- âœ… æ”¯æŒæ¯é¡µæ˜¾ç¤ºæ•°é‡é€‰æ‹©ï¼ˆ10/20/50/100ï¼‰

#### 2.2 æœç´¢å’Œè¿‡æ»¤ä¼˜åŒ–
- âœ… å®ç°äº†é˜²æŠ–æœç´¢åŠŸèƒ½ï¼ˆ500mså»¶è¿Ÿï¼‰
- âœ… ä¼˜åŒ–äº†è§’è‰²è¿‡æ»¤é€‰é¡¹ï¼Œæ”¯æŒæ‰€æœ‰ç³»ç»Ÿè§’è‰²
- âœ… æ”¹è¿›äº†çŠ¶æ€è¿‡æ»¤é€»è¾‘

#### 2.3 ç”¨æˆ·çŠ¶æ€ç®¡ç†
- âœ… ä¿®å¤äº†ç¦ç”¨/å¯ç”¨æŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘
- âœ… ä½¿ç”¨æ­£ç¡®çš„APIç«¯ç‚¹è¿›è¡ŒçŠ¶æ€æ›´æ–°
- âœ… æ·»åŠ äº†æ“ä½œç¡®è®¤å¯¹è¯æ¡†
- âœ… å®ç°äº†çŠ¶æ€æ›´æ–°åçš„è‡ªåŠ¨åˆ·æ–°

### 3. ç”¨æˆ·ä½“éªŒæ”¹è¿›

#### 3.1 ç•Œé¢ä¼˜åŒ–
- âœ… æ”¹è¿›äº†åˆ†é¡µç»„ä»¶çš„æ ·å¼è®¾è®¡
- âœ… ä¼˜åŒ–äº†æŒ‰é’®çš„ç¦ç”¨çŠ¶æ€æ˜¾ç¤º
- âœ… æ·»åŠ äº†åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨

#### 3.2 äº¤äº’ä¼˜åŒ–
- âœ… æœç´¢è¾“å…¥é˜²æŠ–å¤„ç†ï¼Œå‡å°‘ä¸å¿…è¦çš„APIè°ƒç”¨
- âœ… åˆ†é¡µæ“ä½œè‡ªåŠ¨é‡ç½®åˆ°ç¬¬ä¸€é¡µ
- âœ… çŠ¶æ€æ›´æ–°åè‡ªåŠ¨åˆ·æ–°åˆ—è¡¨

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### åç«¯å®ç°

#### ç”¨æˆ·çŠ¶æ€æ›´æ–°API
```python
@api_view(['PATCH'])
@permission_classes([permissions.IsAuthenticated, IsAdminOrReadOnly])
def update_user_status(request, user_id):
    """æ›´æ–°ç”¨æˆ·çŠ¶æ€ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰"""
    try:
        user = User.objects.get(id=user_id)
        is_active = request.data.get('is_active')
        
        if is_active is None:
            return Response({'error': 'is_activeå­—æ®µä¸èƒ½ä¸ºç©º'}, status=status.HTTP_400_BAD_REQUEST)
        
        user.is_active = bool(is_active)
        user.save()
        
        status_text = 'å¯ç”¨' if user.is_active else 'ç¦ç”¨'
        return Response({
            'message': f'ç”¨æˆ·å·²{status_text}',
            'is_active': user.is_active
        })
    except User.DoesNotExist:
        return Response({'error': 'ç”¨æˆ·ä¸å­˜åœ¨'}, status=status.HTTP_404_NOT_FOUND)
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
```

#### ç”¨æˆ·åºåˆ—åŒ–å™¨å¢å¼º
```python
class UserSerializer(serializers.ModelSerializer):
    status = serializers.SerializerMethodField()
    status_text = serializers.SerializerMethodField()
    role_text = serializers.SerializerMethodField()
    register_time = serializers.SerializerMethodField()
    last_login = serializers.SerializerMethodField()
    
    def get_status(self, obj):
        return 'active' if obj.is_active else 'banned'
    
    def get_status_text(self, obj):
        return 'æ´»è·ƒ' if obj.is_active else 'å·²ç¦ç”¨'
    
    def get_role_text(self, obj):
        # æ”¯æŒæ‰€æœ‰ç³»ç»Ÿè§’è‰²çš„æ–‡æœ¬æ˜ å°„
        user_roles = UserRole.objects.filter(user=obj).select_related('role')
        if user_roles.exists():
            role = user_roles.first().role
            role_map = {
                'admin': 'ç®¡ç†å‘˜',
                'enterprise_admin': 'ä¼ä¸šç®¡ç†å‘˜',
                'enterprise_employee': 'ä¼ä¸šå‘˜å·¥',
                # ... æ›´å¤šè§’è‰²æ˜ å°„
            }
            return role_map.get(role.code, role.name)
        return 'æ™®é€šç”¨æˆ·'
```

### å‰ç«¯å®ç°

#### åˆ†é¡µç»„ä»¶
```vue
<!-- åˆ†é¡µç»„ä»¶ -->
<div class="pagination" v-if="totalPages > 1">
  <button 
    class="btn btn-outline" 
    :disabled="currentPage === 1"
    @click="goToPage(currentPage - 1)"
  >
    ä¸Šä¸€é¡µ
  </button>
  
  <span class="page-info">
    ç¬¬ {{ currentPage }} é¡µï¼Œå…± {{ totalPages }} é¡µ
  </span>
  
  <button 
    class="btn btn-outline" 
    :disabled="currentPage === totalPages"
    @click="goToPage(currentPage + 1)"
  >
    ä¸‹ä¸€é¡µ
  </button>
  
  <div class="page-size-selector">
    <label>æ¯é¡µæ˜¾ç¤ºï¼š</label>
    <select v-model="pageSize" @change="changePageSize">
      <option value="10">10</option>
      <option value="20">20</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
  </div>
</div>
```

#### é˜²æŠ–æœç´¢
```javascript
debouncedSearch() {
  if (this.searchTimeout) {
    clearTimeout(this.searchTimeout)
  }
  this.searchTimeout = setTimeout(() => {
    this.currentPage = 1
    this.loadUsers()
  }, 500)
}
```

#### çŠ¶æ€æ›´æ–°åŠŸèƒ½
```javascript
async toggleUserStatus(user) {
  const action = user.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'
  try {
    await ElMessageBox.confirm(`ç¡®å®šè¦${action}ç”¨æˆ· ${user.username} å—ï¼Ÿ`, 'ç¡®è®¤æ“ä½œ', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    
    await api.patch(`/auth/users/${user.id}/status/`, {
      is_active: !user.is_active
    })
    
    ElMessage.success(`ç”¨æˆ·å·²${action}`)
    this.loadUsers()
  } catch (error) {
    if (error !== 'cancel') {
      console.error('æ›´æ–°ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error)
      ElMessage.error('æ“ä½œå¤±è´¥')
    }
  }
}
```

## ğŸ§ª æµ‹è¯•ç»“æœ

### APIæµ‹è¯•ç»“æœ
```
âœ… åˆ†é¡µæŸ¥è¯¢æˆåŠŸ
   - æ€»æ•°é‡: 21
   - ç»“æœæ•°é‡: 20

âœ… çŠ¶æ€æ›´æ–°æˆåŠŸ
   - æµ‹è¯•ç”¨æˆ·: emp_285702 (ID: 23)
   - çŠ¶æ€ä»"æ´»è·ƒ"æ›´æ–°ä¸º"ç¦ç”¨"
   - çŠ¶æ€éªŒè¯æˆåŠŸ

âœ… æœç´¢åŠŸèƒ½æ­£å¸¸
   - æœç´¢å…³é”®è¯: admin
   - æœç´¢ç»“æœæ•°é‡: 1

âœ… çŠ¶æ€è¿‡æ»¤åŠŸèƒ½æ­£å¸¸
   - è¿‡æ»¤æ¡ä»¶: æ´»è·ƒç”¨æˆ·
   - ç»“æœæ•°é‡: 20
   - è¿‡æ»¤ç»“æœéªŒè¯æˆåŠŸ
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶
- `backend/apps/users/views.py` - æ·»åŠ ç”¨æˆ·çŠ¶æ€æ›´æ–°API
- `backend/apps/users/serializers.py` - å¢å¼ºç”¨æˆ·åºåˆ—åŒ–å™¨
- `backend/apps/users/urls.py` - æ·»åŠ æ–°çš„APIè·¯ç”±

### å‰ç«¯æ–‡ä»¶
- `frontend/src/views/system/Users.vue` - å®Œæ•´é‡æ„ç”¨æˆ·ç®¡ç†é¡µé¢

### æµ‹è¯•æ–‡ä»¶
- `test_user_management_fixes.py` - åŠŸèƒ½æµ‹è¯•è„šæœ¬

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨åç«¯æœåŠ¡
cd backend
python manage.py runserver

# å¯åŠ¨å‰ç«¯æœåŠ¡
cd frontend
npm run dev
```

### è®¿é—®é¡µé¢
è®¿é—® `http://localhost:3000/system/users` å³å¯ä½¿ç”¨æ–°çš„ç”¨æˆ·ç®¡ç†åŠŸèƒ½ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### åˆ†é¡µåŠŸèƒ½
- âœ… æ”¯æŒåˆ†é¡µå¯¼èˆªï¼ˆä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µï¼‰
- âœ… æ˜¾ç¤ºå½“å‰é¡µå’Œæ€»é¡µæ•°
- âœ… æ”¯æŒæ¯é¡µæ˜¾ç¤ºæ•°é‡é€‰æ‹©
- âœ… åˆ†é¡µçŠ¶æ€ä¿æŒ

### æœç´¢å’Œè¿‡æ»¤
- âœ… å®æ—¶æœç´¢ï¼ˆé˜²æŠ–å¤„ç†ï¼‰
- âœ… è§’è‰²è¿‡æ»¤
- âœ… çŠ¶æ€è¿‡æ»¤
- âœ… æœç´¢å’Œè¿‡æ»¤ç»„åˆä½¿ç”¨

### ç”¨æˆ·çŠ¶æ€ç®¡ç†
- âœ… ä¸€é”®ç¦ç”¨/å¯ç”¨ç”¨æˆ·
- âœ… æ“ä½œç¡®è®¤å¯¹è¯æ¡†
- âœ… çŠ¶æ€æ›´æ–°åè‡ªåŠ¨åˆ·æ–°
- âœ… é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ

### ç”¨æˆ·ä½“éªŒ
- âœ… åŠ è½½çŠ¶æ€æŒ‡ç¤º
- âœ… å“åº”å¼è®¾è®¡
- âœ… å‹å¥½çš„é”™è¯¯æç¤º
- âœ… æ“ä½œåé¦ˆ

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

1. **æ‰¹é‡æ“ä½œ** - æ·»åŠ æ‰¹é‡ç¦ç”¨/å¯ç”¨åŠŸèƒ½
2. **å¯¼å‡ºåŠŸèƒ½** - æ”¯æŒç”¨æˆ·åˆ—è¡¨å¯¼å‡º
3. **é«˜çº§æœç´¢** - æ·»åŠ æ›´å¤šæœç´¢æ¡ä»¶
4. **ç”¨æˆ·è¯¦æƒ…** - å®Œå–„ç”¨æˆ·è¯¦æƒ…é¡µé¢
5. **æ“ä½œæ—¥å¿—** - è®°å½•ç”¨æˆ·çŠ¶æ€å˜æ›´æ—¥å¿—

## âœ¨ æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº†ç”¨æˆ·ç®¡ç†é¡µé¢çš„æ ¸å¿ƒé—®é¢˜ï¼Œå®ç°äº†ï¼š
- âœ… å®Œæ•´çš„åˆ†é¡µåŠŸèƒ½æ”¯æŒ
- âœ… å¯é çš„ç”¨æˆ·çŠ¶æ€ç®¡ç†
- âœ… ä¼˜åŒ–çš„æœç´¢å’Œè¿‡æ»¤ä½“éªŒ
- âœ… è‰¯å¥½çš„ç”¨æˆ·ç•Œé¢å’Œäº¤äº’

æ‰€æœ‰åŠŸèƒ½éƒ½ç»è¿‡äº†å®Œæ•´çš„æµ‹è¯•éªŒè¯ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚ç”¨æˆ·ç®¡ç†é¡µé¢ç°åœ¨å…·å¤‡äº†ä¼ä¸šçº§åº”ç”¨æ‰€éœ€çš„åŸºæœ¬åŠŸèƒ½ã€‚
