# 系统日志功能说明

## 问题解答

### ❓ 为什么系统日志是空的？

**原因**：之前的系统中虽然定义了 `SystemLog` 模型，但**没有任何代码在实际创建日志记录**。

### ✅ 什么情况下会生成日志？

现在系统已经配置了自动日志记录机制，以下情况会自动生成日志：

#### 1. 自动记录的情况（通过中间件）

✅ **所有写操作请求**
- POST 请求（创建数据）
- PUT 请求（完整更新）
- PATCH 请求（部分更新）
- DELETE 请求（删除数据）

✅ **所有失败的请求**
- 4xx 错误（客户端错误，如400、401、403、404）
- 5xx 错误（服务器错误，如500、502、503）

✅ **慢请求**
- 执行时间超过2秒的API请求会被记录为警告

#### 2. 手动记录的情况

开发者可以在代码中使用工具函数手动记录日志：
- 用户操作日志
- 业务逻辑日志
- 安全相关日志
- 数据库操作日志

---

## 已实现的功能

### 1. 自动日志中间件

**文件**: `backend/apps/system/middleware.py`

#### SystemLogMiddleware（系统日志中间件）

**功能**：
- 自动拦截所有API请求
- 记录请求方法、路径、参数
- 记录响应状态码、执行时间
- 记录用户信息、IP地址、User Agent
- 自动隐藏敏感信息（密码、token等）

**记录规则**：
1. 所有 POST/PUT/PATCH/DELETE 请求
2. 所有状态码 ≥ 400 的请求（错误请求）
3. 只记录 `/api/` 开头的路径
4. 排除静态文件、媒体文件等

**日志级别判断**：
- 5xx 错误 → `ERROR`
- 4xx 错误 → `WARNING`
- 成功请求 → `INFO`

#### PerformanceLogMiddleware（性能日志中间件）

**功能**：
- 监控所有API请求的执行时间
- 自动记录超过2秒的慢请求
- 帮助发现性能问题

---

### 2. 日志工具函数

**文件**: `backend/apps/system/logging_utils.py`

提供便捷的日志记录方法：

```python
from apps.system.logging_utils import (
    log_info,
    log_warning,
    log_error,
    log_user_action,
    log_security,
    log_business
)

# 记录信息
log_info('user_module', '用户注册成功', user=user)

# 记录警告
log_warning('payment', '支付接口响应超时')

# 记录错误
log_error('email', '邮件发送失败', extra_data={'email': email})

# 记录用户操作
log_user_action('project', '创建项目', user=user, extra_data={'project_id': 123})

# 记录安全事件
log_security('auth', '检测到异常登录', risk_level='WARNING')

# 记录业务日志
log_business('order', '订单创建', user=user, extra_data={'order_id': 456})
```

#### 可用的日志函数

| 函数 | 用途 | 日志类型 |
|------|------|----------|
| `log_info()` | 一般信息 | system |
| `log_warning()` | 警告信息 | system |
| `log_error()` | 错误信息 | system |
| `log_debug()` | 调试信息 | system |
| `log_user_action()` | 用户操作 | user |
| `log_security()` | 安全事件 | security |
| `log_business()` | 业务操作 | business |
| `log_api_call()` | API调用 | api |
| `log_database_operation()` | 数据库操作 | database |

#### 装饰器用法

```python
from apps.system.logging_utils import log_function_call

@log_function_call(module='payment', log_type='business')
def process_payment(order_id, amount):
    """处理支付"""
    # 函数执行会自动记录日志
    pass
```

---

### 3. 测试数据生成命令

**文件**: `backend/apps/system/management/commands/generate_test_logs.py`

**用途**：快速生成测试日志数据，用于演示和测试

**使用方法**：

```bash
# 生成50条测试日志（默认）
python manage.py generate_test_logs

# 生成100条测试日志
python manage.py generate_test_logs --count 100

# 生成200条测试日志
python manage.py generate_test_logs --count 200
```

**生成的日志类型**：
- ✅ 用户登录/登出日志
- ✅ 创建项目/任务日志
- ✅ 发布信息/上传资源日志
- ✅ 权限错误日志
- ✅ 资源不存在日志
- ✅ 数据库错误日志
- ✅ 慢请求日志

**日志时间分布**：
- 随机分布在过去7天内
- 模拟真实的使用场景

---

## 日志字段说明

### SystemLog 模型字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `level` | CharField | 日志级别（DEBUG/INFO/WARNING/ERROR/CRITICAL） |
| `log_type` | CharField | 日志类型（system/user/api/database/security/business） |
| `module` | CharField | 模块名称（auth/enterprises/persons等） |
| `message` | TextField | 日志消息 |
| `user` | ForeignKey | 关联用户（可为空） |
| `ip_address` | GenericIPAddressField | 客户端IP地址 |
| `user_agent` | TextField | 浏览器User Agent |
| `request_path` | CharField | 请求路径 |
| `request_method` | CharField | 请求方法（GET/POST/PUT/DELETE） |
| `response_status` | IntegerField | HTTP响应状态码 |
| `execution_time` | FloatField | 执行时间（秒） |
| `extra_data` | JSONField | 额外数据（JSON格式） |
| `created_at` | DateTimeField | 创建时间 |

---

## 日志级别说明

| 级别 | 英文 | 中文 | 用途 |
|------|------|------|------|
| DEBUG | DEBUG | 调试 | 开发调试信息 |
| INFO | INFO | 信息 | 一般操作信息 |
| WARNING | WARNING | 警告 | 警告信息，不影响正常运行 |
| ERROR | ERROR | 错误 | 错误信息，影响功能 |
| CRITICAL | CRITICAL | 严重 | 严重错误，系统无法运行 |

---

## 日志类型说明

| 类型 | 英文 | 中文 | 用途 |
|------|------|------|------|
| system | system | 系统日志 | 系统级别的操作和事件 |
| user | user | 用户操作 | 用户的各种操作 |
| api | api | API访问 | API接口调用记录 |
| database | database | 数据库操作 | 数据库相关操作 |
| security | security | 安全日志 | 安全相关事件 |
| business | business | 业务日志 | 业务逻辑相关 |

---

## 配置说明

### settings.py 配置

已在 `backend/config/settings.py` 中添加了日志中间件：

```python
MIDDLEWARE = [
    # ... 其他中间件 ...
    'apps.system.middleware.SystemLogMiddleware',      # 系统日志中间件
    'apps.system.middleware.PerformanceLogMiddleware',  # 性能日志中间件
]
```

### 中间件配置选项

可以在 `middleware.py` 中调整以下配置：

**SystemLogMiddleware**:
- `exclude_paths`: 不记录日志的路径列表
- `log_methods`: 需要记录的HTTP方法列表

**PerformanceLogMiddleware**:
- `slow_request_threshold`: 慢请求阈值（秒），默认2.0秒

---

## 使用示例

### 1. 查看日志

通过前端页面：
1. 登录系统
2. 点击"系统管理" → "系统日志"
3. 使用筛选和搜索功能查看日志

### 2. 生成测试日志

```bash
cd backend
python manage.py generate_test_logs --count 100
```

### 3. 在代码中记录日志

**示例1：记录用户登录**

```python
from apps.system.logging_utils import log_user_action, log_security

def login(request):
    # ... 登录逻辑 ...
    
    if login_success:
        log_user_action(
            'auth',
            f'用户 {username} 登录成功',
            user=user,
            ip_address=get_client_ip(request)
        )
    else:
        log_security(
            'auth',
            f'登录失败：用户名 {username}',
            risk_level='WARNING',
            ip_address=get_client_ip(request)
        )
```

**示例2：记录项目创建**

```python
from apps.system.logging_utils import log_business

def create_project(request):
    # ... 创建项目逻辑 ...
    
    log_business(
        'projects',
        f'创建项目：{project.name}',
        user=request.user,
        extra_data={
            'project_id': project.id,
            'project_name': project.name
        }
    )
```

**示例3：记录错误**

```python
from apps.system.logging_utils import log_error

try:
    # ... 一些可能出错的操作 ...
    send_email(to, subject, content)
except Exception as e:
    log_error(
        'email',
        f'邮件发送失败：{str(e)}',
        extra_data={
            'to': to,
            'subject': subject,
            'error': str(e)
        }
    )
```

---

## 日志查询示例

### Django Shell 查询

```python
python manage.py shell

from apps.system.models import SystemLog
from django.utils import timezone
from datetime import timedelta

# 获取所有日志
all_logs = SystemLog.objects.all()

# 获取今天的日志
today = timezone.now().date()
today_logs = SystemLog.objects.filter(created_at__date=today)

# 获取错误日志
error_logs = SystemLog.objects.filter(level='ERROR')

# 获取某个用户的日志
user_logs = SystemLog.objects.filter(user__username='admin')

# 获取最近一小时的日志
one_hour_ago = timezone.now() - timedelta(hours=1)
recent_logs = SystemLog.objects.filter(created_at__gte=one_hour_ago)

# 获取特定模块的日志
auth_logs = SystemLog.objects.filter(module='auth')

# 按日志级别统计
from django.db.models import Count
stats = SystemLog.objects.values('level').annotate(count=Count('id'))
```

---

## 日志清理

### 定期清理旧日志

建议定期清理过期日志，避免数据库膨胀：

```python
# 删除30天前的日志
from django.utils import timezone
from datetime import timedelta
from apps.system.models import SystemLog

thirty_days_ago = timezone.now() - timedelta(days=30)
deleted_count = SystemLog.objects.filter(created_at__lt=thirty_days_ago).delete()
print(f'删除了 {deleted_count[0]} 条日志')
```

可以创建定时任务自动执行清理。

---

## 性能考虑

### 1. 异步记录（推荐用于生产环境）

当前实现是同步记录，在高并发场景下可能影响性能。建议在生产环境使用：
- Celery 异步任务
- 消息队列（RabbitMQ/Redis）
- 日志聚合服务（ELK/Splunk）

### 2. 批量写入

对于大量日志，可以使用 `bulk_create` 批量插入：

```python
logs = []
for i in range(1000):
    logs.append(SystemLog(
        level='INFO',
        module='test',
        message=f'Test log {i}'
    ))

SystemLog.objects.bulk_create(logs, batch_size=100)
```

### 3. 索引优化

`SystemLog` 模型已经创建了以下索引：
- `(level, created_at)`
- `(log_type, created_at)`
- `(user, created_at)`
- `(module, created_at)`

这些索引可以加速常见的查询操作。

---

## 故障排查

### 问题1：日志没有生成

**检查步骤**：
1. 确认中间件已添加到 `settings.py`
2. 确认是API请求（路径以 `/api/` 开头）
3. 确认是写操作或错误请求
4. 检查数据库表是否存在：`python manage.py migrate`

### 问题2：日志记录失败

**检查步骤**：
1. 查看Django控制台是否有错误输出
2. 确认数据库连接正常
3. 确认 `SystemLog` 表结构正确

### 问题3：日志太多导致性能问题

**解决方案**：
1. 调整中间件的 `exclude_paths`，排除不需要的路径
2. 调整 `log_methods`，只记录特定方法
3. 实施定期清理策略
4. 考虑使用异步记录

---

## 总结

✅ **自动日志记录**：通过中间件自动记录所有重要操作  
✅ **灵活的工具函数**：支持手动记录各类日志  
✅ **完整的测试工具**：可快速生成测试数据  
✅ **详细的日志信息**：包含用户、IP、执行时间等完整信息  
✅ **前端可视化**：通过系统管理界面查看和筛选日志  

现在系统日志功能已经完全可用！只要有API请求操作，就会自动生成日志记录。

---

**文档更新时间**: 2025年10月22日  
**版本**: v1.0

