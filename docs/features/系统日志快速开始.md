# 系统日志快速开始指南

## 🎯 一分钟快速体验

### 步骤1：生成测试日志

在项目根目录执行：

```bash
cd backend
python manage.py generate_test_logs --count 50
```

**输出示例**：
```
开始生成 50 条测试日志...
✓ 成功生成 50 条测试日志

日志统计:
  总计: 50
  信息: 32
  警告: 12
  错误: 6
```

### 步骤2：查看日志

1. 启动前端和后端服务
2. 登录系统（使用管理员账号）
3. 点击左侧菜单：**系统管理** → **系统日志**
4. 现在可以看到刚才生成的50条日志！

### 步骤3：体验筛选功能

在系统日志页面尝试：
- 🔍 搜索关键词（如"登录"、"项目"）
- 📊 按级别筛选（信息/警告/错误）
- 🏷️ 按模块筛选（auth/enterprises/persons）
- 📅 按日期筛选
- 👁️ 点击"查看"按钮查看日志详情

---

## 📝 现在日志什么时候会自动生成？

### ✅ 自动记录的操作

一旦配置完成，以下操作会**自动生成日志**：

#### 1. 用户操作
- ✅ 用户登录/登出
- ✅ 用户注册
- ✅ 修改密码
- ✅ 更新个人信息

#### 2. 企业管理
- ✅ 创建/编辑/删除项目
- ✅ 添加/编辑/删除员工
- ✅ 更新企业信息

#### 3. 个人中心
- ✅ 创建/编辑/删除任务
- ✅ 创建/编辑/删除项目

#### 4. 信息广场
- ✅ 发布/编辑/删除信息
- ✅ 点赞/取消点赞

#### 5. 资源管理
- ✅ 上传/删除资源

#### 6. 系统管理
- ✅ 创建/编辑/删除用户
- ✅ 创建/编辑/删除角色
- ✅ 修改系统配置
- ✅ 创建系统备份

#### 7. 所有错误
- ✅ 401 未授权
- ✅ 403 权限不足
- ✅ 404 资源不存在
- ✅ 500 服务器错误

#### 8. 性能监控
- ✅ 响应时间超过2秒的慢请求

---

## 🔧 配置已完成

以下配置已自动完成，**无需额外操作**：

### ✅ 中间件已注册

在 `backend/config/settings.py` 中：

```python
MIDDLEWARE = [
    # ... 其他中间件 ...
    'apps.system.middleware.SystemLogMiddleware',      # ← 已添加
    'apps.system.middleware.PerformanceLogMiddleware', # ← 已添加
]
```

### ✅ 工具函数已创建

文件 `backend/apps/system/logging_utils.py` 包含：
- `log_info()` - 记录信息
- `log_warning()` - 记录警告
- `log_error()` - 记录错误
- `log_user_action()` - 记录用户操作
- `log_security()` - 记录安全事件
- ... 等等

### ✅ 测试命令已创建

可以随时使用：
```bash
python manage.py generate_test_logs --count 数量
```

---

## 💡 下一步可以做什么？

### 1. 测试实时日志生成

尝试在系统中执行一些操作，然后刷新日志页面：

1. **测试用户操作**：
   - 登出再登录 → 查看日志页面，会看到新的登录日志

2. **测试创建操作**：
   - 创建一个新项目 → 查看日志，会看到 POST 请求日志

3. **测试错误日志**：
   - 尝试访问不存在的资源 → 会生成404错误日志

### 2. 在代码中使用日志工具

在 Django 视图中添加日志记录：

```python
from apps.system.logging_utils import log_user_action, log_error

# 在视图函数中
def create_project(request):
    try:
        # 创建项目逻辑
        project = Project.objects.create(...)
        
        # 记录成功日志
        log_user_action(
            'projects',
            f'创建项目：{project.name}',
            user=request.user
        )
        
        return Response({'success': True})
    except Exception as e:
        # 记录错误日志
        log_error(
            'projects',
            f'创建项目失败：{str(e)}',
            user=request.user
        )
        return Response({'error': str(e)}, status=500)
```

### 3. 查看日志统计

在 Django Shell 中：

```bash
python manage.py shell
```

```python
from apps.system.models import SystemLog
from django.db.models import Count

# 按级别统计
SystemLog.objects.values('level').annotate(count=Count('id'))

# 按模块统计
SystemLog.objects.values('module').annotate(count=Count('id')).order_by('-count')

# 查看最新10条日志
SystemLog.objects.all()[:10]
```

---

## 🎨 日志页面功能

### 筛选功能
- 🔍 **搜索框**：搜索日志消息内容
- 📊 **级别筛选**：信息/警告/错误/调试
- 🏷️ **模块筛选**：认证/用户/项目/系统
- 📅 **日期筛选**：选择特定日期

### 操作功能
- 👁️ **查看详情**：查看完整的日志信息
- 📥 **导出日志**：导出筛选后的日志
- 🗑️ **清空日志**：清空所有日志记录

### 分页功能
- 每页显示数量可调：10/20/50条
- 上一页/下一页导航
- 总数和页码显示

---

## 📊 日志详情包含的信息

每条日志记录包含：

| 信息项 | 说明 | 示例 |
|--------|------|------|
| 时间 | 日志创建时间 | 2025-10-22 15:30:45 |
| 级别 | 日志级别 | 信息/警告/错误 |
| 模块 | 所属模块 | auth/enterprises/persons |
| 用户 | 操作用户 | admin/user123 |
| 操作 | 操作描述 | POST /api/v1/auth/login/ - 200 |
| IP地址 | 客户端IP | 192.168.1.100 |

点击"查看"按钮可以看到更详细的信息：
- User Agent（浏览器信息）
- 请求路径
- 请求方法
- 响应状态码
- 执行时间
- 额外数据（JSON格式）

---

## ❓ 常见问题

### Q1: 为什么有些操作没有生成日志？

**A**: 以下情况不会生成日志：
- GET 请求（除非发生错误）
- 访问静态文件（/static/, /media/）
- 非API路径（不以 /api/ 开头）

### Q2: 如何生成更多测试日志？

**A**: 
```bash
# 生成100条
python manage.py generate_test_logs --count 100

# 生成500条
python manage.py generate_test_logs --count 500
```

### Q3: 日志会自动清理吗？

**A**: 目前不会自动清理，建议：
1. 定期手动清理
2. 在系统日志页面使用"清空日志"功能
3. 或在 Django Shell 中删除旧日志：
   ```python
   from apps.system.models import SystemLog
   from django.utils import timezone
   from datetime import timedelta
   
   # 删除30天前的日志
   thirty_days_ago = timezone.now() - timedelta(days=30)
   SystemLog.objects.filter(created_at__lt=thirty_days_ago).delete()
   ```

### Q4: 如何只查看自己的操作日志？

**A**: 在系统日志页面：
1. 不筛选（或筛选"用户操作"类型）
2. 搜索你的用户名
3. 或在代码中查询：
   ```python
   SystemLog.objects.filter(user=request.user)
   ```

---

## 🚀 开始使用

1. **生成测试数据**：
   ```bash
   python manage.py generate_test_logs --count 50
   ```

2. **查看日志**：
   - 登录系统
   - 系统管理 → 系统日志

3. **执行一些操作**：
   - 创建项目、发布信息等
   - 刷新日志页面查看新日志

4. **体验筛选功能**：
   - 尝试不同的筛选条件
   - 查看日志详情

---

**就这么简单！** 🎉

现在你的系统已经具备完整的日志记录和查看功能了！

