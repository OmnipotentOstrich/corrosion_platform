/* empty css             *//* empty css                   *//* empty css                   *//* empty css                  *//* empty css                 *//* empty css                    */import{c,o as d,d as i,ak as E,e as n,x as f,al as D,H as b,I as v,w as r,aK as A,a8 as C,an as _,B as g,L as u,ax as T,S as B,g as I,q as S,s as U,aO as M,aE as N,aP as L,J as z,i as H}from"./index-B_YfpHek.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";const q={name:"SystemRoles",data(){return{roles:[],loading:!1,roleDialogVisible:!1,isEditing:!1,submitting:!1,allPermissions:[],checkAll:!1,isIndeterminate:!1,roleForm:{id:null,name:"",code:"",description:"",is_active:!0,selectedPermissions:[]},roleFormRules:{name:[{required:!0,message:"请输入角色名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],code:[{max:50,message:"长度不能超过 50 个字符",trigger:"blur"}]}}},computed:{groupedPermissions(){const s={};return this.allPermissions.forEach(e=>{const o=this.getPermissionCategory(e.code);s[o]||(s[o]=[]),s[o].push(e)}),Object.keys(s).map(e=>({category:e,permissions:s[e]}))}},mounted(){this.loadRoles(),this.loadPermissions()},methods:{async loadRoles(){try{this.loading=!0;const s=await _.get("/auth/roles/"),e=s.data.results||s.data||[];this.roles=e.map(o=>({id:o.id,name:o.name||"未命名角色",description:o.description||"暂无描述",level:o.level||"low",levelText:this.getLevelText(o.level),userCount:o.user_count||o.users?.length||0,permissionCount:o.permission_count||o.permissions?.length||0,permissions:o.permissions||[],deletable:!o.is_system&&o.id>3,...o}))}catch(s){console.error("加载角色列表失败:",s),g.error("加载角色列表失败"),this.roles=[]}finally{this.loading=!1}},getLevelText(s){return{high:"高级",medium:"中级",low:"普通"}[s]||"普通"},async loadPermissions(){try{const s=await _.get("/auth/permissions/");this.allPermissions=s.data.results||s.data||[]}catch(s){console.error("加载权限列表失败:",s),this.allPermissions=[]}},getPermissionName(s){return typeof s=="string"?s:s?.name||s?.code||"未知权限"},getPermissionCategory(s){const e={user:"用户管理",role:"角色管理",enterprise:"企业管理",info:"信息管理",resource:"资源管理",system:"系统管理"},o=s.split("_")[0];return e[o]||"其他权限"},showAddRoleDialog(){this.isEditing=!1,this.roleForm={id:null,name:"",code:"",description:"",is_active:!0,selectedPermissions:[]},this.checkAll=!1,this.isIndeterminate=!1,this.roleDialogVisible=!0,this.$nextTick(()=>{this.$refs.roleFormRef?.clearValidate()})},showEditRoleDialog(s){this.isEditing=!0,this.roleForm={id:s.id,name:s.name,code:s.code,description:s.description||"",is_active:s.is_active!==!1,selectedPermissions:s.permissions.map(e=>e.id)},this.updateCheckAllStatus(),this.roleDialogVisible=!0,this.$nextTick(()=>{this.$refs.roleFormRef?.clearValidate()})},handleCheckAllChange(s){this.roleForm.selectedPermissions=s?this.allPermissions.map(e=>e.id):[],this.isIndeterminate=!1},handleCheckedPermissionsChange(s){this.updateCheckAllStatus()},updateCheckAllStatus(){const s=this.roleForm.selectedPermissions.length;this.checkAll=s===this.allPermissions.length,this.isIndeterminate=s>0&&s<this.allPermissions.length},async submitRoleForm(){if(await this.$refs.roleFormRef.validate().catch(()=>!1))try{this.submitting=!0;const e={name:this.roleForm.name,code:this.roleForm.code||"role_"+Date.now(),description:this.roleForm.description,is_active:this.roleForm.is_active,permission_ids:this.roleForm.selectedPermissions};this.isEditing?(await _.put(`/auth/roles/${this.roleForm.id}/`,e),g.success("角色更新成功")):(await _.post("/auth/roles/",e),g.success("角色创建成功")),this.roleDialogVisible=!1,this.loadRoles()}catch(e){console.error("提交角色失败:",e);let o=this.isEditing?"更新角色失败":"创建角色失败";if(e.response?.data){const p=e.response.data;p.code?o+=": 角色代码已存在":p.name?o+=": 角色名称已存在":typeof p=="string"?o+=": "+p:p.detail&&(o+=": "+p.detail)}g.error(o)}finally{this.submitting=!1}},viewRole(s){const e=s.permissions.map(o=>`<span style="display: inline-block; background: #e9ecef; padding: 2px 6px; margin: 2px; border-radius: 3px; font-size: 12px;">${this.getPermissionName(o)}</span>`).join("");C.alert(`
        <div style="text-align: left;">
          <h3>${s.name}</h3>
          <p><strong>描述：</strong>${s.description}</p>
          <p><strong>级别：</strong>${s.levelText}</p>
          <p><strong>用户数：</strong>${s.userCount}</p>
          <p><strong>权限数：</strong>${s.permissionCount}</p>
          <p><strong>权限列表：</strong></p>
          <div style="margin-top: 10px;">${e||"暂无权限"}</div>
        </div>
      `,"角色详情",{dangerouslyUseHTMLString:!0,confirmButtonText:"关闭"})},async deleteRole(s){try{await C.confirm(`确定要删除角色"${s.name}"吗？此操作不可恢复。`,"确认删除",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"error"}),await _.delete(`/auth/roles/${s.id}/`),g.success("角色已删除"),this.loadRoles()}catch(e){e!=="cancel"&&(console.error("删除角色失败:",e),g.error("删除角色失败"))}}}},O={class:"system-roles"},G={class:"page-header"},J={class:"header-actions"},K={class:"roles-grid"},Q={class:"role-header"},W={class:"role-description"},X={class:"role-stats"},Y={class:"permissions"},Z={class:"permission-list"},$={class:"role-actions"},ee=["onClick"],se=["onClick"],te=["onClick"],oe={class:"permissions-selector"},ie={style:{color:"#999","font-size":"12px"}},le={class:"dialog-footer"};function ne(s,e,o,p,l,m){const y=U,h=S,V=M,k=N,F=L,P=I,x=H,w=A,R=D;return d(),c("div",O,[i("div",G,[e[10]||(e[10]=i("h1",null,"角色管理",-1)),i("div",J,[i("button",{class:"btn btn-primary",onClick:e[0]||(e[0]=(...t)=>m.showAddRoleDialog&&m.showAddRoleDialog(...t))},[...e[9]||(e[9]=[i("span",{style:{"margin-right":"5px"}},"+",-1),f(" 添加角色 ",-1)])])])]),E((d(),c("div",K,[(d(!0),c(b,null,v(l.roles,t=>(d(),c("div",{key:t.id,class:"role-card"},[i("div",Q,[i("h3",null,u(t.name),1),i("span",{class:T(["role-badge",t.level])},u(t.levelText),3)]),i("p",W,u(t.description),1),i("div",X,[i("span",null,"用户数: "+u(t.userCount),1),i("span",null,"权限数: "+u(t.permissionCount),1)]),i("div",Y,[e[11]||(e[11]=i("h4",null,"权限列表",-1)),i("div",Z,[(d(!0),c(b,null,v(t.permissions,a=>(d(),c("span",{key:a.id||a.code,class:"permission-tag"},u(m.getPermissionName(a)),1))),128))])]),i("div",$,[i("button",{class:"btn btn-sm btn-outline",onClick:a=>m.viewRole(t)}," 查看详情 ",8,ee),i("button",{class:"btn btn-sm btn-primary",onClick:a=>m.showEditRoleDialog(t)}," 编辑 ",8,se),t.deletable?(d(),c("button",{key:0,class:"btn btn-sm btn-danger",onClick:a=>m.deleteRole(t)}," 删除 ",8,te)):B("",!0)])]))),128))])),[[R,l.loading]]),n(w,{modelValue:l.roleDialogVisible,"onUpdate:modelValue":e[8]||(e[8]=t=>l.roleDialogVisible=t),title:l.isEditing?"编辑角色":"添加角色",width:"600px","close-on-click-modal":!1},{footer:r(()=>[i("span",le,[n(x,{onClick:e[7]||(e[7]=t=>l.roleDialogVisible=!1)},{default:r(()=>[...e[15]||(e[15]=[f("取消",-1)])]),_:1}),n(x,{type:"primary",onClick:m.submitRoleForm,loading:l.submitting},{default:r(()=>[f(u(l.isEditing?"保存":"创建"),1)]),_:1},8,["onClick","loading"])])]),default:r(()=>[n(P,{model:l.roleForm,rules:l.roleFormRules,ref:"roleFormRef","label-width":"100px"},{default:r(()=>[n(h,{label:"角色名称",prop:"name"},{default:r(()=>[n(y,{modelValue:l.roleForm.name,"onUpdate:modelValue":e[1]||(e[1]=t=>l.roleForm.name=t),placeholder:"请输入角色名称",clearable:""},null,8,["modelValue"])]),_:1}),n(h,{label:"角色代码",prop:"code"},{default:r(()=>[n(y,{modelValue:l.roleForm.code,"onUpdate:modelValue":e[2]||(e[2]=t=>l.roleForm.code=t),placeholder:"自动生成或手动输入，如: role_manager",clearable:""},null,8,["modelValue"]),e[12]||(e[12]=i("span",{style:{"font-size":"12px",color:"#999"}},"留空将自动生成",-1))]),_:1}),n(h,{label:"角色描述",prop:"description"},{default:r(()=>[n(y,{modelValue:l.roleForm.description,"onUpdate:modelValue":e[3]||(e[3]=t=>l.roleForm.description=t),type:"textarea",rows:3,placeholder:"请输入角色描述",clearable:""},null,8,["modelValue"])]),_:1}),n(h,{label:"角色状态",prop:"is_active"},{default:r(()=>[n(V,{modelValue:l.roleForm.is_active,"onUpdate:modelValue":e[4]||(e[4]=t=>l.roleForm.is_active=t),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1}),n(h,{label:"权限配置"},{default:r(()=>[i("div",oe,[n(k,{modelValue:l.checkAll,"onUpdate:modelValue":e[5]||(e[5]=t=>l.checkAll=t),indeterminate:l.isIndeterminate,onChange:m.handleCheckAllChange},{default:r(()=>[...e[13]||(e[13]=[f(" 全选 ",-1)])]),_:1},8,["modelValue","indeterminate","onChange"]),e[14]||(e[14]=i("div",{style:{margin:"15px 0"}},null,-1)),n(F,{modelValue:l.roleForm.selectedPermissions,"onUpdate:modelValue":e[6]||(e[6]=t=>l.roleForm.selectedPermissions=t),onChange:m.handleCheckedPermissionsChange},{default:r(()=>[(d(!0),c(b,null,v(m.groupedPermissions,t=>(d(),c("div",{key:t.category,class:"permission-group"},[i("h4",null,u(t.category),1),(d(!0),c(b,null,v(t.permissions,a=>(d(),z(k,{key:a.id,label:a.id,style:{display:"block",margin:"8px 0"}},{default:r(()=>[f(u(a.name)+" ",1),i("span",ie,"("+u(a.code)+")",1)]),_:2},1032,["label"]))),128))]))),128))]),_:1},8,["modelValue","onChange"])])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])])}const he=j(q,[["render",ne],["__scopeId","data-v-a3df6278"]]);export{he as default};
