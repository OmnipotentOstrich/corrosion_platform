# 快速开始指南 - v2.0

## 🎯 系统概述

防腐保温智能数字平台 v2.0 已成功完善组织架构层和系统配置层功能，提供企业级的用户管理、权限控制、系统监控和管理能力。

## ✅ 当前状态

- ✅ 数据库表已创建（13个新增 + 4个增强）
- ✅ 迁移已应用
- ✅ 所有功能测试通过
- ✅ API接口已就绪（50+ 新增）

## 🚀 快速启动

### 1. 环境准备

确保您已安装以下软件：
- Python 3.8+
- MySQL 5.7+
- Node.js 16+
- npm 或 yarn

### 2. 后端启动

```bash
# 进入后端目录
cd backend

# 安装依赖
pip install -r requirements.txt

# 配置数据库（如果还没有配置）
# 编辑 config/settings.py 或创建 .env 文件

# 启动服务
python manage.py runserver
```

后端服务将在 `http://localhost:8000` 启动

### 3. 前端启动

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

前端服务将在 `http://localhost:5173` 启动

## 📊 功能验证

### 1. 测试新功能

```bash
# 运行完整功能测试
python test_enhanced_features.py
```

预期输出：
```
=== 测试总结 ===
✅ 所有功能测试完成！
✅ 创建/验证了 25 个用户
✅ 创建/验证了 14 个角色
✅ 创建/验证了 48 个权限
✅ 创建/验证了 21 个菜单
✅ 创建/验证了 8 个系统配置
✅ 创建/验证了 1 个安全日志
✅ 创建/验证了 1 个分析数据
✅ 创建/验证了 1 个维护计划
✅ 创建/验证了 1 个备份记录

🎉 所有测试通过！
```

### 2. 访问管理后台

1. 打开浏览器访问：`http://localhost:8000/admin`
2. 使用超级管理员账户登录
3. 查看新增的数据模型：
   - 用户资料 (User Profiles)
   - 用户会话 (User Sessions)
   - 用户活动日志 (User Activity Logs)
   - 权限组 (Permission Groups)
   - 角色权限审计 (Role Permission Audits)
   - 用户权限覆盖 (User Permission Overrides)
   - 系统安全日志 (System Security Logs)
   - 系统页面配置 (System Page Configs)
   - 系统分析数据 (System Analytics)
   - 系统维护计划 (System Maintenance)

### 3. API接口测试

#### 获取用户资料
```bash
curl -X GET http://localhost:8000/api/users/profile/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 获取安全日志
```bash
curl -X GET http://localhost:8000/api/system/security/security-logs/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 获取系统性能监控
```bash
curl -X GET http://localhost:8000/api/system/monitoring/performance/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 🔐 权限配置

### 1. 创建权限组

```python
from apps.users.models import PermissionGroup

# 创建用户管理权限组
user_mgmt_group = PermissionGroup.objects.create(
    name='用户管理权限组',
    code='user_management_group',
    description='用户管理相关权限',
    module='users',
    sort_order=1,
    is_active=True
)
```

### 2. 分配角色权限

```python
from apps.users.models import Role, Permission, RolePermission

role = Role.objects.get(code='admin')
permission = Permission.objects.get(code='users.view_userprofile')

RolePermission.objects.create(
    role=role,
    permission=permission
)
```

### 3. 设置用户权限覆盖

```python
from apps.users.models import User, Permission, UserPermissionOverride
from django.utils import timezone
from datetime import timedelta

user = User.objects.get(username='specific_user')
permission = Permission.objects.get(code='system.create_backup')

# 临时授予权限（7天后过期）
UserPermissionOverride.objects.create(
    user=user,
    permission=permission,
    is_granted=True,
    reason='临时需要执行备份操作',
    granted_by=admin_user,
    expire_at=timezone.now() + timedelta(days=7),
    is_active=True
)
```

## 📈 数据分析

### 1. 记录用户行为

```python
from apps.users.models import UserActivityLog

UserActivityLog.objects.create(
    user=user,
    action='create_post',
    description='发布了一条信息',
    ip_address='192.168.1.100',
    user_agent='Mozilla/5.0...',
    request_path='/api/info-plaza/posts/'
)
```

### 2. 创建分析数据

```python
from apps.system.models import SystemAnalytics
from django.utils import timezone

SystemAnalytics.objects.create(
    analytics_type='user_behavior',
    metric_name='daily_active_users',
    metric_value=150,
    dimension_data={'platform': 'web', 'device': 'desktop'},
    time_period='daily',
    analysis_date=timezone.now().date()
)
```

### 3. 查看分析仪表板

访问：`http://localhost:8000/api/system/analytics/analytics-dashboard/`

## 🔒 安全监控

### 1. 创建安全事件

```python
from apps.system.models import SystemSecurityLog

SystemSecurityLog.objects.create(
    security_type='login_failure',
    user=user,
    ip_address='192.168.1.100',
    user_agent='Mozilla/5.0...',
    description='连续5次登录失败',
    risk_level='high'
)
```

### 2. 查看安全仪表板

访问：`http://localhost:8000/api/system/security/security-dashboard/`

### 3. 解决安全事件

```bash
curl -X POST http://localhost:8000/api/system/security/security-events/1/resolve/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 🛠️ 系统维护

### 1. 创建维护计划

```python
from apps.system.models import SystemMaintenance
from django.utils import timezone
from datetime import timedelta

SystemMaintenance.objects.create(
    maintenance_type='scheduled',
    title='数据库优化维护',
    description='定期数据库优化和清理',
    status='planned',
    scheduled_start=timezone.now() + timedelta(days=1),
    scheduled_end=timezone.now() + timedelta(days=1, hours=2),
    created_by=admin_user
)
```

### 2. 开始维护

```bash
curl -X POST http://localhost:8000/api/system/maintenance/maintenance/1/start/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 完成维护

```bash
curl -X POST http://localhost:8000/api/system/maintenance/maintenance/1/complete/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 💾 数据备份

### 1. 创建备份

```python
from apps.system.models import SystemBackup
from django.utils import timezone

SystemBackup.objects.create(
    backup_type='database',
    name=f'backup_{timezone.now().strftime("%Y%m%d_%H%M%S")}',
    description='定时备份',
    status='pending',
    created_by=admin_user
)
```

### 2. 查看备份状态

访问：`http://localhost:8000/api/system/monitoring/backup-status/`

## 📱 页面配置

### 1. 创建页面配置

```python
from apps.system.models import SystemPageConfig

SystemPageConfig.objects.create(
    page_name='dashboard',
    page_type='dashboard',
    title='仪表板',
    description='系统仪表板页面',
    keywords='dashboard,仪表板,统计',
    layout_config={
        'columns': 3,
        'widgets': ['statistics', 'charts', 'notifications']
    },
    theme_config={
        'primary_color': '#409EFF',
        'theme': 'light'
    },
    is_active=True
)
```

### 2. 更新页面配置

```bash
curl -X PUT http://localhost:8000/api/system/pages/page-configs/1/ \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "新的仪表板标题",
    "theme_config": {
      "primary_color": "#67C23A",
      "theme": "dark"
    }
  }'
```

## 🎯 常用操作

### 1. 查看用户会话

```python
from apps.users.models import UserSession

# 获取活跃会话
active_sessions = UserSession.objects.filter(is_active=True)

# 获取特定用户的会话
user_sessions = UserSession.objects.filter(user=user)
```

### 2. 查看用户活动日志

```python
from apps.users.models import UserActivityLog
from django.utils import timezone
from datetime import timedelta

# 获取最近7天的活动
recent_activities = UserActivityLog.objects.filter(
    created_at__gte=timezone.now() - timedelta(days=7)
)

# 获取特定类型的活动
login_activities = UserActivityLog.objects.filter(action='login')
```

### 3. 查看权限审计日志

```python
from apps.users.models import RolePermissionAudit

# 获取权限授予记录
grant_audits = RolePermissionAudit.objects.filter(action='grant')

# 获取特定角色的审计记录
role_audits = RolePermissionAudit.objects.filter(role=role)
```

## 🐛 故障排除

### 问题1：表不存在

如果遇到 "Table doesn't exist" 错误：

```bash
# 运行表创建脚本
cd backend
python create_missing_tables.py
python create_system_tables.py
```

### 问题2：迁移历史不一致

如果遇到迁移历史不一致错误：

```bash
# 运行修复脚本
cd backend
python fix_migrations.py
```

### 问题3：字段不存在

如果遇到 "Unknown column" 错误：

```bash
# 运行修复脚本
cd backend
python fix_menus_table.py
```

## 📞 技术支持

如遇到问题，请查看以下文档：
- [功能完善总结](./组织架构层和系统配置层功能完善总结.md)
- [最终报告](./组织架构层和系统配置层功能完善-最终报告.md)

## 🎉 下一步

1. **配置前端路由** - 将新增的API接口集成到前端
2. **自定义权限规则** - 根据业务需求配置权限
3. **设置监控告警** - 配置安全事件和性能告警
4. **优化数据分析** - 根据实际数据调整分析维度
5. **制定维护计划** - 设置定期维护任务

---

**版本**: v2.0.0  
**更新时间**: 2024-10-22  
**状态**: ✅ 生产就绪

