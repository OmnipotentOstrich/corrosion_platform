# 数据库迁移指南

## 概述
本文档说明如何为防腐保温智能数字平台执行数据库迁移和初始化。

## 前置条件

### 系统要求
- Python 3.8+
- MySQL 8.0+
- pip包管理器

### 环境配置
确保已安装所有依赖：
```bash
cd backend
pip install -r requirements.txt
```

## 方案一：使用SQL文件直接初始化（推荐用于首次部署）

### 步骤1：创建数据库
```sql
CREATE DATABASE IF NOT EXISTS corrosion_platform 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

### 步骤2：导入数据库结构
```bash
mysql -u root -p corrosion_platform < database_schema.sql
```

或使用MySQL客户端：
```sql
USE corrosion_platform;
SOURCE /path/to/database_schema.sql;
```

### 步骤3：验证数据库
```sql
-- 查看所有表
SHOW TABLES;

-- 查看表结构
DESCRIBE users;

-- 查看视图
SHOW FULL TABLES WHERE TABLE_TYPE LIKE 'VIEW';

-- 查看存储过程
SHOW PROCEDURE STATUS WHERE Db = 'corrosion_platform';

-- 查看触发器
SHOW TRIGGERS;
```

### 步骤4：配置Django数据库连接
编辑 `backend/config/settings.py`：
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'corrosion_platform',
        'USER': 'your_username',
        'PASSWORD': 'your_password',
        'HOST': 'localhost',
        'PORT': '3306',
        'OPTIONS': {
            'charset': 'utf8mb4',
            'init_command': "SET sql_mode='STRICT_TRANS_TABLES'",
        }
    }
}
```

### 步骤5：同步Django迁移状态
由于数据库已经通过SQL文件创建，需要告诉Django迁移已完成：
```bash
cd backend
python manage.py migrate --fake
```

## 方案二：使用Django迁移（推荐用于开发环境）

### 步骤1：创建数据库
```sql
CREATE DATABASE IF NOT EXISTS corrosion_platform 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

### 步骤2：配置数据库连接
编辑 `backend/config/settings.py` 如方案一步骤4。

### 步骤3：创建迁移文件
```bash
cd backend

# 为每个应用创建迁移
python manage.py makemigrations users
python manage.py makemigrations enterprises
python manage.py makemigrations persons
python manage.py makemigrations info_plaza
python manage.py makemigrations resources
python manage.py makemigrations system
```

### 步骤4：检查迁移文件
查看生成的迁移文件，确保正确：
```bash
# 查看迁移计划
python manage.py showmigrations

# 查看SQL语句（不执行）
python manage.py sqlmigrate users 0001
```

### 步骤5：应用迁移
```bash
# 应用所有迁移
python manage.py migrate

# 或分别应用每个应用的迁移
python manage.py migrate users
python manage.py migrate enterprises
python manage.py migrate persons
python manage.py migrate info_plaza
python manage.py migrate resources
python manage.py migrate system
```

### 步骤6：加载初始数据
```bash
# 如果有fixture文件
python manage.py loaddata initial_data.json

# 或使用自定义管理命令
python manage.py init_roles_permissions
python manage.py init_menus
python manage.py init_categories
```

## 创建管理员用户

### 交互式创建
```bash
python manage.py createsuperuser
```

按提示输入：
- 用户名
- 邮箱
- 手机号
- 密码

### 脚本创建
创建文件 `backend/create_admin.py`：
```python
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from apps.users.models import User, Role, UserRole

# 创建管理员用户
admin_user = User.objects.create_superuser(
    username='admin',
    email='admin@corrosion-platform.com',
    password='admin123456',  # 请在生产环境使用强密码
    phone='13800138000',
    user_type='personal',
    is_verified=True
)

# 分配管理员角色
try:
    admin_role = Role.objects.get(code='admin')
    UserRole.objects.create(user=admin_user, role=admin_role)
    print(f"管理员用户创建成功: {admin_user.username}")
except Role.DoesNotExist:
    print("警告: 管理员角色不存在，请先初始化角色数据")

print("管理员账号信息:")
print(f"用户名: admin")
print(f"密码: admin123456")
print("请在生产环境修改默认密码！")
```

运行脚本：
```bash
python backend/create_admin.py
```

## 初始化基础数据

### 创建初始化脚本
创建文件 `backend/init_data.py`：
```python
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from apps.users.models import Role, Permission, Menu
from apps.info_plaza.models import InfoCategory
from apps.resources.models import ResourceType
from apps.system.models import SystemConfig

def init_roles():
    """初始化角色"""
    roles = [
        {'name': '系统管理员', 'code': 'admin', 'description': '系统管理员，拥有所有权限'},
        {'name': '企业管理员', 'code': 'enterprise_admin', 'description': '企业管理员，管理企业相关功能'},
        {'name': '企业员工', 'code': 'enterprise_employee', 'description': '企业员工，使用企业功能'},
        {'name': '个人用户', 'code': 'personal_user', 'description': '个人用户，使用个人功能'},
    ]
    
    for role_data in roles:
        Role.objects.get_or_create(
            code=role_data['code'],
            defaults=role_data
        )
    print("角色初始化完成")

def init_info_categories():
    """初始化信息分类"""
    categories = [
        {'name': '供应信息', 'code': 'supply', 'description': '产品供应、服务提供等信息', 'icon': 'ShoppingCart', 'sort_order': 1},
        {'name': '需求信息', 'code': 'demand', 'description': '产品需求、服务需求等信息', 'icon': 'ShoppingBag', 'sort_order': 2},
        {'name': '招聘信息', 'code': 'recruitment', 'description': '人才招聘、岗位需求等信息', 'icon': 'User', 'sort_order': 3},
        {'name': '招标信息', 'code': 'tender', 'description': '项目招标、采购招标等信息', 'icon': 'Document', 'sort_order': 4},
        {'name': '技术文章', 'code': 'technology', 'description': '技术分享、经验交流等文章', 'icon': 'Reading', 'sort_order': 5},
        {'name': '行业资讯', 'code': 'news', 'description': '行业动态、政策资讯等信息', 'icon': 'Bell', 'sort_order': 6},
    ]
    
    for category_data in categories:
        InfoCategory.objects.get_or_create(
            code=category_data['code'],
            defaults=category_data
        )
    print("信息分类初始化完成")

def init_resource_types():
    """初始化资源类型"""
    types = [
        {'name': '设备', 'code': 'equipment', 'description': '各种防腐保温设备', 'icon': 'Tools', 'sort_order': 1},
        {'name': '材料', 'code': 'material', 'description': '防腐保温材料', 'icon': 'Box', 'sort_order': 2},
        {'name': '人才', 'code': 'talent', 'description': '专业技术人才', 'icon': 'User', 'sort_order': 3},
        {'name': '技术', 'code': 'technology', 'description': '技术服务和解决方案', 'icon': 'Setting', 'sort_order': 4},
    ]
    
    for type_data in types:
        ResourceType.objects.get_or_create(
            code=type_data['code'],
            defaults=type_data
        )
    print("资源类型初始化完成")

def init_system_configs():
    """初始化系统配置"""
    configs = [
        {'key': 'site_name', 'value': '防腐保温智能数字平台', 'config_type': 'basic', 'description': '网站名称'},
        {'key': 'site_description', 'value': '专业的防腐保温行业数字化平台', 'config_type': 'basic', 'description': '网站描述'},
        {'key': 'site_keywords', 'value': '防腐,保温,数字化,平台', 'config_type': 'basic', 'description': '网站关键词'},
        {'key': 'contact_email', 'value': 'admin@corrosion-platform.com', 'config_type': 'basic', 'description': '联系邮箱'},
        {'key': 'contact_phone', 'value': '400-123-4567', 'config_type': 'basic', 'description': '联系电话'},
    ]
    
    for config_data in configs:
        SystemConfig.objects.get_or_create(
            key=config_data['key'],
            defaults=config_data
        )
    print("系统配置初始化完成")

if __name__ == '__main__':
    print("开始初始化数据...")
    init_roles()
    init_info_categories()
    init_resource_types()
    init_system_configs()
    print("数据初始化完成！")
```

运行初始化脚本：
```bash
python backend/init_data.py
```

## 数据备份与恢复

### 备份数据库
```bash
# 备份整个数据库
mysqldump -u root -p corrosion_platform > backup_$(date +%Y%m%d_%H%M%S).sql

# 备份特定表
mysqldump -u root -p corrosion_platform users roles permissions > backup_users.sql

# 备份数据（不包括表结构）
mysqldump -u root -p --no-create-info corrosion_platform > backup_data.sql
```

### 恢复数据库
```bash
# 恢复整个数据库
mysql -u root -p corrosion_platform < backup_20241016_120000.sql

# 恢复特定表
mysql -u root -p corrosion_platform < backup_users.sql
```

## 常见问题

### 问题1：迁移冲突
**症状**：执行migrate时提示迁移冲突

**解决方案**：
```bash
# 查看冲突的迁移
python manage.py showmigrations

# 手动解决冲突
python manage.py migrate --merge

# 或删除冲突的迁移文件后重新生成
rm apps/users/migrations/0002_conflict.py
python manage.py makemigrations
python manage.py migrate
```

### 问题2：外键约束错误
**症状**：导入SQL时提示外键约束错误

**解决方案**：
```sql
-- 临时禁用外键检查
SET FOREIGN_KEY_CHECKS = 0;

-- 导入数据
SOURCE /path/to/database_schema.sql;

-- 重新启用外键检查
SET FOREIGN_KEY_CHECKS = 1;
```

### 问题3：字符编码问题
**症状**：中文显示为乱码

**解决方案**：
```sql
-- 修改数据库字符集
ALTER DATABASE corrosion_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 修改表字符集
ALTER TABLE users CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 问题4：权限不足
**症状**：执行迁移时提示权限不足

**解决方案**：
```sql
-- 授予用户权限
GRANT ALL PRIVILEGES ON corrosion_platform.* TO 'your_user'@'localhost';
FLUSH PRIVILEGES;
```

## 迁移检查清单

- [ ] 数据库已创建
- [ ] 数据库字符集为 utf8mb4
- [ ] Django数据库配置正确
- [ ] 所有依赖已安装
- [ ] 迁移文件已生成
- [ ] 迁移已成功应用
- [ ] 管理员用户已创建
- [ ] 基础数据已初始化
- [ ] 数据库已备份
- [ ] 触发器已创建
- [ ] 存储过程已创建
- [ ] 视图已创建
- [ ] 索引已优化

## 下一步

完成数据库迁移后，可以：
1. 启动开发服务器测试
2. 访问Django管理后台
3. 测试API接口
4. 进行前端开发
5. 进行集成测试

## 生产环境注意事项

1. **安全**：
   - 使用强密码
   - 限制数据库访问
   - 定期更新密钥

2. **性能**：
   - 优化索引
   - 配置连接池
   - 启用查询缓存

3. **备份**：
   - 设置定时备份
   - 保留多个备份版本
   - 测试恢复流程

4. **监控**：
   - 监控数据库性能
   - 设置告警阈值
   - 记录慢查询

## 参考资源

- [Django迁移文档](https://docs.djangoproject.com/en/4.2/topics/migrations/)
- [MySQL官方文档](https://dev.mysql.com/doc/)
- [Django REST Framework](https://www.django-rest-framework.org/)

