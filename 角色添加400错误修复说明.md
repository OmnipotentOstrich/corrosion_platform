# è§’è‰²æ·»åŠ 400é”™è¯¯ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ç‚¹å‡»"æ·»åŠ è§’è‰²"æŒ‰é’®åï¼Œè¾“å…¥è§’è‰²åç§°å¹¶ç¡®è®¤ï¼Œåç«¯è¿”å› **400 Bad Request** é”™è¯¯ï¼š

```
Failed to load resource: the server responded with a status of 400 (Bad Request)
æ·»åŠ è§’è‰²å¤±è´¥: AxiosError
```

## ğŸ” é—®é¢˜åŸå› 

### 1. åç«¯æ¨¡å‹è¦æ±‚

æŸ¥çœ‹ `backend/apps/users/models.py` ä¸­çš„ `Role` æ¨¡å‹å®šä¹‰ï¼š

```python
class Role(models.Model):
    """è§’è‰²æ¨¡å‹"""
    name = models.CharField(max_length=50, unique=True, verbose_name='è§’è‰²åç§°')
    code = models.CharField(max_length=50, unique=True, verbose_name='è§’è‰²ä»£ç ')  # â† å¿…å¡«å­—æ®µ
    description = models.TextField(blank=True, verbose_name='è§’è‰²æè¿°')
    is_active = models.BooleanField(default=True, verbose_name='æ˜¯å¦å¯ç”¨')
    ...
```

**å…³é”®é—®é¢˜:**
- `code` å­—æ®µæ˜¯**å¿…å¡«çš„** (æ²¡æœ‰ `blank=True`)
- `code` å­—æ®µå¿…é¡»æ˜¯**å”¯ä¸€çš„** (unique=True)

### 2. å‰ç«¯å‘é€çš„æ•°æ®

**åŸä»£ç ï¼ˆé”™è¯¯ï¼‰:**
```javascript
await api.post('/auth/roles/', {
  name: value,        // âœ“ æä¾›äº†
  description: '',
  permissions: []
  // âœ— ç¼ºå°‘ code å­—æ®µï¼
})
```

**å¯¼è‡´çš„é”™è¯¯:**
- Django REST Framework éªŒè¯å¤±è´¥
- è¿”å› 400 é”™è¯¯ï¼š`{"code": ["This field is required."]}`

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶: `frontend/src/views/system/Roles.vue`

**ä¿®æ”¹å‰:**
```javascript
async addRole() {
  const { value } = await ElMessageBox.prompt('è¯·è¾“å…¥è§’è‰²åç§°', 'æ·»åŠ è§’è‰²', {
    confirmButtonText: 'ç¡®å®š',
    cancelButtonText: 'å–æ¶ˆ'
  })
  
  await api.post('/auth/roles/', {
    name: value,
    description: '',
    permissions: []
  })
  
  ElMessage.success(`è§’è‰² ${value} æ·»åŠ æˆåŠŸ`)
}
```

**ä¿®æ”¹å:**
```javascript
async addRole() {
  const { value } = await ElMessageBox.prompt('è¯·è¾“å…¥è§’è‰²åç§°', 'æ·»åŠ è§’è‰²', {
    confirmButtonText: 'ç¡®å®š',
    cancelButtonText: 'å–æ¶ˆ',
    inputPattern: /.+/,
    inputErrorMessage: 'è§’è‰²åç§°ä¸èƒ½ä¸ºç©º'
  })
  
  // âœ… ç”Ÿæˆå”¯ä¸€çš„è§’è‰²ä»£ç 
  const code = 'role_' + Date.now()
  
  await api.post('/auth/roles/', {
    name: value,
    code: code,        // âœ… æ·»åŠ  code å­—æ®µ
    description: '',
    permissions: []
  })
  
  ElMessage.success(`è§’è‰² ${value} æ·»åŠ æˆåŠŸ`)
  this.loadRoles()
}
```

### æ”¹è¿›ç‚¹

1. âœ… **è‡ªåŠ¨ç”Ÿæˆ code å­—æ®µ**
   - æ ¼å¼: `role_` + æ—¶é—´æˆ³
   - ç¤ºä¾‹: `role_1729567890123`
   - ç¡®ä¿å”¯ä¸€æ€§

2. âœ… **å¢å¼ºé”™è¯¯å¤„ç†**
   ```javascript
   catch (error) {
     if (error !== 'cancel') {
       let errorMsg = 'æ·»åŠ è§’è‰²å¤±è´¥'
       if (error.response?.data) {
         const errData = error.response.data
         if (errData.code) {
           errorMsg += ': è§’è‰²ä»£ç å·²å­˜åœ¨'
         } else if (errData.name) {
           errorMsg += ': è§’è‰²åç§°å·²å­˜åœ¨'
         } else if (typeof errData === 'string') {
           errorMsg += ': ' + errData
         }
       }
       ElMessage.error(errorMsg)
     }
   }
   ```

3. âœ… **æ·»åŠ è¾“å…¥éªŒè¯**
   - ä½¿ç”¨ `inputPattern` éªŒè¯éç©º
   - æä¾›é”™è¯¯æç¤ºä¿¡æ¯

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1: æ·»åŠ è§’è‰²

1. **åˆ·æ–°æµè§ˆå™¨é¡µé¢**
   ```
   æŒ‰ Ctrl + Shift + R
   ```

2. **è®¿é—®è§’è‰²ç®¡ç†é¡µé¢**
   ```
   http://localhost:5173/dashboard/system/roles
   ```

3. **ç‚¹å‡»"æ·»åŠ è§’è‰²"æŒ‰é’®**

4. **è¾“å…¥è§’è‰²åç§°**
   - ä¾‹å¦‚: "æµ‹è¯•è§’è‰²"

5. **ç‚¹å‡»ç¡®å®š**

6. **é¢„æœŸç»“æœ**
   - âœ… æ˜¾ç¤º "è§’è‰² æµ‹è¯•è§’è‰² æ·»åŠ æˆåŠŸ"
   - âœ… è§’è‰²åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°
   - âœ… æ–°è§’è‰²å‡ºç°åœ¨åˆ—è¡¨ä¸­
   - âœ… æ²¡æœ‰400é”™è¯¯

---

### æµ‹è¯•2: é‡å¤åç§°

1. **æ·»åŠ ä¸€ä¸ªè§’è‰²**ï¼ˆå¦‚"ç»ç†"ï¼‰

2. **å†æ¬¡æ·»åŠ åŒåè§’è‰²**

3. **é¢„æœŸç»“æœ**
   - âœ… æ˜¾ç¤ºé”™è¯¯æç¤º: "æ·»åŠ è§’è‰²å¤±è´¥: è§’è‰²åç§°å·²å­˜åœ¨"

---

### æµ‹è¯•3: æ£€æŸ¥ç”Ÿæˆçš„code

1. **æ·»åŠ ä¸€ä¸ªè§’è‰²**

2. **æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network**

3. **æŸ¥çœ‹ POST è¯·æ±‚çš„ Payload**
   ```json
   {
     "name": "æµ‹è¯•è§’è‰²",
     "code": "role_1729567890123",  // â† è‡ªåŠ¨ç”Ÿæˆ
     "description": "",
     "permissions": []
   }
   ```

4. **é¢„æœŸç»“æœ**
   - âœ… code å­—æ®µå­˜åœ¨
   - âœ… code æ ¼å¼æ­£ç¡®
   - âœ… æ¯æ¬¡ç”Ÿæˆçš„ code éƒ½ä¸åŒ

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| å‘é€æ•°æ® | åªæœ‰ name | name + code |
| code ç”Ÿæˆ | âŒ æ—  | âœ… role_æ—¶é—´æˆ³ |
| åç«¯å“åº” | 400 é”™è¯¯ | 200 æˆåŠŸ |
| é”™è¯¯æç¤º | é€šç”¨æç¤º | å…·ä½“é”™è¯¯ä¿¡æ¯ |
| è¾“å…¥éªŒè¯ | âŒ æ—  | âœ… éç©ºéªŒè¯ |

## ğŸ¯ å…¶ä»–è§£å†³æ–¹æ¡ˆï¼ˆå¯é€‰ï¼‰

### æ–¹æ¡ˆ1: è®©ç”¨æˆ·è¾“å…¥code

```javascript
// åˆ›å»ºä¸€ä¸ªè¡¨å•å¯¹è¯æ¡†ï¼ŒåŒæ—¶è¾“å…¥ name å’Œ code
ElMessageBox({
  title: 'æ·»åŠ è§’è‰²',
  message: h('div', [
    h('label', 'Role Name:'),
    h('input', { ref: 'nameInput' }),
    h('label', 'Role Code:'),
    h('input', { ref: 'codeInput' })
  ])
})
```

**ä¼˜ç‚¹:** ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ code
**ç¼ºç‚¹:** å¢åŠ ç”¨æˆ·æ“ä½œå¤æ‚åº¦

### æ–¹æ¡ˆ2: ä»åç§°ç”Ÿæˆcodeï¼ˆæ‹¼éŸ³ï¼‰

```javascript
// ä½¿ç”¨ pinyin åº“
import pinyin from 'pinyin'

const code = pinyin(value, {
  style: pinyin.STYLE_NORMAL
}).join('_').toLowerCase()

// "ç³»ç»Ÿç®¡ç†å‘˜" â†’ "xi_tong_guan_li_yuan"
```

**ä¼˜ç‚¹:** code æ›´æœ‰æ„ä¹‰
**ç¼ºç‚¹:** éœ€è¦é¢å¤–ä¾èµ–åº“

### æ–¹æ¡ˆ3: åç«¯è‡ªåŠ¨ç”Ÿæˆï¼ˆæ¨èï¼‰

ä¿®æ”¹åç«¯åºåˆ—åŒ–å™¨ï¼Œè®© `code` å­—æ®µå¯é€‰ï¼š

```python
class RoleSerializer(serializers.ModelSerializer):
    code = serializers.CharField(required=False)
    
    class Meta:
        model = Role
        fields = ['id', 'name', 'code', 'description', ...]
    
    def create(self, validated_data):
        if 'code' not in validated_data:
            # è‡ªåŠ¨ç”Ÿæˆ code
            validated_data['code'] = f"role_{int(time.time() * 1000)}"
        return super().create(validated_data)
```

**ä¼˜ç‚¹:** 
- å‰åç«¯éƒ½ç®€åŒ–
- æ›´ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™
- ç”¨æˆ·ä½“éªŒæœ€å¥½

**ç¼ºç‚¹:** éœ€è¦ä¿®æ”¹åç«¯ä»£ç 

## ğŸ”„ PowerShell å‘½ä»¤ä¿®æ­£

å¦‚æœéœ€è¦åœ¨ PowerShell ä¸­æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œä½¿ç”¨åˆ†å· `;` è€Œä¸æ˜¯ `&&`ï¼š

**é”™è¯¯:**
```powershell
cd frontend && npm run dev
```

**æ­£ç¡®:**
```powershell
cd frontend; npm run dev
```

æˆ–è€…ï¼š
```powershell
cd frontend
npm run dev
```

## ğŸ“… ä¿®å¤æ—¶é—´
2025-10-21

## ğŸ“Œ ç‰ˆæœ¬
v6.0

---

**ä¿®å¤å®Œæˆï¼** ç°åœ¨æ·»åŠ è§’è‰²åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚è¯·åˆ·æ–°é¡µé¢å¹¶æµ‹è¯•ã€‚ ğŸ‰



