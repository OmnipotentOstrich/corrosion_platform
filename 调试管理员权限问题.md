# 🔍 调试管理员权限问题

## 当前状态

✅ **后端已修复** - 登录响应包含 `is_staff: true` 和 `is_superuser: true`  
❓ **前端问题** - 显示"没有权限访问该资源"

---

## 快速诊断

### 请告诉我以下信息：

#### 1. 登录时的情况
- [ ] 是否看到"管理员登录成功！"的提示？
- [ ] 页面URL是否变成了 `/dashboard/system`？
- [ ] 是否看到了系统管理页面的内容（用户管理、角色管理等卡片）？

#### 2. 错误出现的时机
- [ ] 点击登录按钮后立即显示错误？
- [ ] 页面跳转后显示错误？
- [ ] 还是进入页面一段时间后显示？

#### 3. 浏览器控制台（F12 → Console）
- 是否有红色错误信息？
- 请截图或复制错误信息

#### 4. Network 请求（F12 → Network）
- 除了 login 请求，还有哪些请求？
- 哪个请求返回了 403 状态码？
- 请找到返回 403 的请求，告诉我：
  - 请求的 URL 是什么？
  - Response 内容是什么？

---

## 调试步骤

### Step 1: 清除缓存并完整测试

1. **清除所有内容**
   ```
   F12 → Application → Storage → Clear site data
   或者
   F12 → Application → Local Storage → 右键 Clear
   ```

2. **刷新页面** (F5)

3. **打开 Network 标签**
   - 勾选 "Preserve log"
   - 勾选 "Disable cache"

4. **打开 Console 标签** 

5. **点击"系统管理员"登录按钮**

6. **观察并记录**：
   - Console 中的所有输出
   - Network 中所有的请求
   - 特别注意红色（失败）的请求

### Step 2: 查看具体的403请求

在 Network 标签中：
1. 找到状态码为 **403** 的请求
2. 点击它
3. 查看 **Headers** 标签 → Request URL
4. 查看 **Response** 标签 → 响应内容

**请告诉我**：
- 请求的完整 URL
- Response 内容

### Step 3: 测试单个API

打开浏览器 Console，登录后执行：

```javascript
// 测试获取用户菜单
fetch('/api/v1/auth/user-menus/', {
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
})
.then(r => r.json())
.then(data => console.log('菜单API:', data))
.catch(err => console.error('菜单API错误:', err))

// 测试系统统计API
fetch('/api/v1/system/statistics/dashboard/', {
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
})
.then(r => r.json())
.then(data => console.log('系统统计API:', data))
.catch(err => console.error('系统统计API错误:', err))
```

**记录输出结果**。

---

## 可能的原因分析

### 原因1: getUserMenus() 失败

**症状**: 登录后立即显示错误

**原因**: `/auth/user-menus/` API 返回 403

**解决方案**: 检查后端该API的权限设置

### 原因2: 系统统计API失败

**症状**: 进入系统管理页面后显示错误

**原因**: `/system/statistics/dashboard/` API 返回 403

**解决方案**: 检查该API的权限配置

### 原因3: Token未正确传递

**症状**: 所有需要认证的请求都失败

**检查**: 
```javascript
// 在Console中执行
console.log('Token:', localStorage.getItem('token'))
console.log('Token是否存在:', !!localStorage.getItem('token'))
```

### 原因4: 前端store未正确更新

**检查**:
```javascript
// 在Console中执行（登录后）
// 注意：由于模块系统限制，这个可能无法直接执行
// 但可以在登录成功后立即在代码中打印
```

---

## 临时调试代码

### 在 Login.vue 中添加调试信息

修改 `handleAdminLogin` 函数，添加更多日志：

```javascript
const handleAdminLogin = async () => {
  try {
    adminLoading.value = true
    
    console.log('🔹 开始管理员登录...')
    
    const result = await userStore.login({
      username: 'admin',
      password: 'admin123'
    })
    
    console.log('🔹 登录结果:', result)
    console.log('🔹 用户信息:', result.user)
    console.log('🔹 is_staff:', result.user?.is_staff)
    console.log('🔹 is_superuser:', result.user?.is_superuser)
    console.log('🔹 store.isAdmin:', userStore.isAdmin)
    
    if (result.success) {
      ElMessage.success('管理员登录成功！')
      console.log('🔹 准备跳转到 /dashboard/system')
      await router.push('/dashboard/system')
      console.log('🔹 跳转完成')
    } else {
      console.error('❌ 登录失败:', result.error)
    }
  } catch (error) {
    console.error('❌ 登录异常:', error)
    console.error('❌ 错误详情:', error.response?.data)
    ElMessage.error('管理员登录失败，请检查后端服务是否运行')
  } finally {
    adminLoading.value = false
  }
}
```

### 在 user store 的 getUserMenus 中添加日志

`frontend/src/stores/user.js`:

```javascript
const getUserMenus = async () => {
  try {
    console.log('🔹 开始获取用户菜单...')
    const response = await api.get('/auth/user-menus/')
    console.log('🔹 菜单数据:', response.data)
    menus.value = response.data
    return response.data
  } catch (error) {
    console.error('❌ 获取用户菜单失败:', error)
    console.error('❌ 状态码:', error.response?.status)
    console.error('❌ 错误详情:', error.response?.data)
    return []
  }
}
```

---

## 快速测试脚本

### 在浏览器Console中运行（登录后）

```javascript
// 完整诊断脚本
(async function() {
  console.log('===== 权限诊断开始 =====')
  
  // 1. 检查本地存储
  const token = localStorage.getItem('token')
  console.log('1️⃣ Token存在:', !!token)
  console.log('   Token长度:', token?.length)
  
  // 2. 测试用户菜单API
  console.log('\n2️⃣ 测试用户菜单API...')
  try {
    const menuRes = await fetch('/api/v1/auth/user-menus/', {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    })
    console.log('   状态码:', menuRes.status)
    const menuData = await menuRes.json()
    console.log('   响应:', menuData)
  } catch (err) {
    console.error('   错误:', err)
  }
  
  // 3. 测试系统统计API
  console.log('\n3️⃣ 测试系统统计API...')
  try {
    const statsRes = await fetch('/api/v1/system/statistics/dashboard/', {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    })
    console.log('   状态码:', statsRes.status)
    if (statsRes.ok) {
      const statsData = await statsRes.json()
      console.log('   响应:', statsData)
    } else {
      const errorData = await statsRes.text()
      console.error('   错误响应:', errorData)
    }
  } catch (err) {
    console.error('   错误:', err)
  }
  
  // 4. 测试用户信息API
  console.log('\n4️⃣ 测试用户信息API...')
  try {
    const profileRes = await fetch('/api/v1/auth/profile/', {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    })
    console.log('   状态码:', profileRes.status)
    const profileData = await profileRes.json()
    console.log('   用户信息:', profileData)
    console.log('   is_staff:', profileData.is_staff)
    console.log('   is_superuser:', profileData.is_superuser)
  } catch (err) {
    console.error('   错误:', err)
  }
  
  console.log('\n===== 权限诊断结束 =====')
})()
```

---

## 下一步

### 请执行以下操作：

1. ✅ 运行上面的"完整诊断脚本"
2. ✅ 复制所有Console输出
3. ✅ 告诉我哪个API返回了403
4. ✅ 提供那个403请求的Response内容

### 然后我会：

根据具体的403错误，修改相应的后端权限配置或前端请求逻辑。

---

**等待您的反馈！** 请提供：
- 诊断脚本的完整输出
- 哪个API返回403
- 403响应的详细内容


